
---
  title: Analysis Survey 2022
  
  This file was started on 07/15/2022 by Ana√Øs
  Content: preliminary analysis of the survey, to back up some model assumptions.
---
  
```{r echo=FALSE, message=FALSE, results='hide'}
rm(list=ls())
gc()
```

```{r echo=FALSE, message=FALSE, results='hide'}
#library(plyr)
#library(dplyr)
library(tidyr)
library(fastDummies)
library(reshape2)
library(corrplot)
library(stargazer)
library(stringr)
library(parallel)
library(evd)  # \342\200\230~/R/x86_64-redhat-linux-gnu-library/3.5\342\200\231 (personal library in Hawk)
library(magic)
library(mvtnorm)
library(LaplacesDemon)
library(truncnorm)
library(compiler)
library(feather)
library(magrittr)
library(geosphere)
library(plyr)
library(tidyr)
library(fastDummies)
library(reshape2)
library(corrplot)
library(stargazer)
library(stringr)
#library(tidyverse)
library(haven)
library(MASS)
library(stringi)
library(openxlsx)
library(readxl)
library(dplyr)
```

```{r}
dropbox_dir <- "~/Dropbox/"
```

# Preprocess for Analysis RCT --------------------

## Read data and merge
```{r}
car <- read.csv(paste(dropbox_dir, "/Mistakes Structural/Code/Python/Cartillas/data/2022/carreras_v2.csv", sep=''), header=TRUE, sep=";")

dm_int <- read.csv(file = paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/outputs/2022/preprocessing_rct_interim.csv", sep=""), header=TRUE, sep=";")
dm_fin <- read.csv(file = paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/outputs/2022/preprocessing_rct_finales.csv", sep=""), header=TRUE, sep=";")
scores <- read.csv(file = paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/data/2022/puntajes_consolidado_v3.csv", sep=""), header=TRUE, sep=",")

colnames(dm_int)[2:length(colnames(dm_int))] <- paste(colnames(dm_int)[2:length(colnames(dm_int))], '_int', sep='')
colnames(dm_fin)[2:length(colnames(dm_fin))] <- paste(colnames(dm_fin)[2:length(colnames(dm_int))], '_fin', sep='')
```

```{r}
dm <- merge(dm_int, dm_fin, by="mrun")
```

```{r}
dm %<>% mutate(apps_before = (codigo_carrera_1_int > 0) + (codigo_carrera_2_int > 0) +
                             (codigo_carrera_3_int > 0) + (codigo_carrera_4_int > 0) +
                             (codigo_carrera_5_int > 0) + (codigo_carrera_6_int > 0) +
                             (codigo_carrera_7_int > 0) + (codigo_carrera_8_int > 0) +
                             (codigo_carrera_9_int > 0) + (codigo_carrera_10_int > 0),
              valid_apps_before = (marca_1_int == 25) + (marca_2_int == 25) +
                                  (marca_3_int == 25) + (marca_4_int == 25) +
                                  (marca_5_int == 25) + (marca_6_int == 25) +
                                  (marca_7_int == 25) + (marca_8_int == 25) +
                                  (marca_9_int == 25) + (marca_10_int == 25) ,
               apps_after = (codigo_carrera_1_fin > 0) + (codigo_carrera_2_fin > 0) +
                             (codigo_carrera_3_fin > 0) + (codigo_carrera_4_fin > 0) +
                             (codigo_carrera_5_fin > 0) + (codigo_carrera_6_fin > 0) +
                             (codigo_carrera_7_fin > 0) + (codigo_carrera_8_fin > 0) +
                             (codigo_carrera_9_fin > 0) + (codigo_carrera_10_fin > 0),
              valid_apps_after = (marca_1_fin == 25) + (marca_2_fin == 25) +
                                  (marca_3_fin == 25) + (marca_4_fin == 25) +
                                  (marca_5_fin == 25) + (marca_6_fin == 25) +
                                  (marca_7_fin == 25) + (marca_8_fin == 25) +
                                  (marca_9_fin == 25) + (marca_10_fin == 25) ,
              changed_apps = (codigo_carrera_1_int != codigo_carrera_1_fin) + (codigo_carrera_2_int != codigo_carrera_2_fin) +
                             (codigo_carrera_3_int != codigo_carrera_3_fin) + (codigo_carrera_4_int != codigo_carrera_4_fin) +
                             (codigo_carrera_5_int != codigo_carrera_5_fin) + (codigo_carrera_6_int != codigo_carrera_6_fin) +
                             (codigo_carrera_7_int != codigo_carrera_7_fin) + (codigo_carrera_8_int != codigo_carrera_8_fin) +
                             (codigo_carrera_9_int != codigo_carrera_9_fin) + (codigo_carrera_10_int != codigo_carrera_10_fin)
            )

```

```{r}
of <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/data/2022/seleccion_20_01_22.csv", sep=''))
open <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/data/2022/accesos-cartilla-postulaciones.csv", sep=''))
pumi <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/data/2022/accesos-cartilla-puntajes.csv", sep=''))
pumi %<>% dplyr::rename(MRUN = id, pumi = ingreso)
ms <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/outputs/2022/master_students_with_treatment_and_stratas.csv", sep=''), header=TRUE, sep=',')
#TODO: we need to check how the probability variables that are in the object ms were computed and if we have to just drop them now
ms %<>% select(!(starts_with("prob") | starts_with("overall")))

op <- open %>% group_by(distinct_id) %>% dplyr::summarise(t_open = min(time)) %>% mutate(open = 1) %>% dplyr::rename(MRUN = distinct_id)
df <- merge(ms, of, by.x="MRUN", by.y="mrun", all.x=TRUE)
df <- merge(df, dm, by.x="MRUN", by.y="mrun", all.x=TRUE)

df <- merge(df, op, by="MRUN", all.x=TRUE)
df$open[is.na(df$open)] <- 0

df <- merge(df, pumi, by="MRUN", all.x=TRUE)
df$pumi[is.na(df$pumi)] <- 0
```

```{r}
df %<>% mutate(assigned_oficial = ifelse((estado_pref_01 %in% c(24, 26)) + (estado_pref_02 %in% c(24, 26)) +
                          (estado_pref_03 %in% c(24, 26)) + (estado_pref_04 %in% c(24, 26)) +
                          (estado_pref_05 %in% c(24, 26)) + (estado_pref_06 %in% c(24, 26)) +
                          (estado_pref_07 %in% c(24, 26)) + (estado_pref_08 %in% c(24, 26)) +
                          (estado_pref_09 %in% c(24, 26)) + (estado_pref_10 %in% c(24, 26)) > 0, 1, 0))

df %<>% mutate(changed = ifelse(changed_apps > 0, 1, 0),
               increased = ifelse(apps_after > apps_before, 1, 0),
               decreased = ifelse(apps_after < apps_before, 1, 0))

df %<>% mutate(reduced_mistakes = ifelse(changed == 1 & valid_apps_before < valid_apps_after, 1, 0))

df %<>% mutate(increased_valid = ifelse(valid_apps_after > valid_apps_before & valid_apps_before<apps_before, 1, 0),
               decreased_valid = ifelse(valid_apps_after < valid_apps_before  & valid_apps_before<apps_before , 1, 0))
```



## Preprocessing programs
```{r}
of <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/data/2022/seleccion_20_01_22.csv", sep=''))
car <- read.csv(paste(dropbox_dir, "/Mistakes Structural/Code/Python/Cartillas/data/2022/carreras_v2.csv", sep=''), header=TRUE, sep=";")

of_l <- reshape(of[,c(1,4:53)], direction='long',
                    varying=colnames(of[,4:53]),
                    times=c('01', '02', '03', '04', '05', '06', '07', '08', '09', '10'),
                    v.names=c('cod_carrera_pref', 'estado_pref','ptje_pref', 'lugar_pref', 'pond_acad_pref'),
                    idvar='mrun')
colnames(of_l) <- c("mrun", "pref", "codigo_carrera", "marca", "orden", "puntano", "puntpond") # this is just me not knowing how to use reshape
# I can tell! JAJAJAJAJA

cutoffs <- of_l %>% filter(marca == 24) %>% group_by(codigo_carrera) %>% dplyr::summarise(num_admitted = n(), min_score = pmax(min(puntpond), 210.0))
#TODO: this is not taking into account that many programs do not fill their vacancies. We
# can assign max(min_pond, 210) for those that do not fill VACANTES_REG
car %<>% mutate(VACANTES_REG = VACANTES_1_SEMESTRE + VACANTES_2_SEMESTRE + SOBRECUPO_1_SEMESTRE + SOBRECUPO_2_SEMESTRE)
car <- merge(car, cutoffs, by.x="CODIGO_DEMRE", by.y="codigo_carrera", all.x=TRUE)
```




## Consolidate interim and final assignment

```{r}
reg_int <- read.csv(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/asignacion_obtenida_reg_interim_completando_con_finales.csv", sep=''), header=TRUE, sep=';')
bea_int <- read.csv(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/asignacion_obtenida_bea_interim_completando_con_finales.csv", sep=''), header=TRUE, sep=';')
pace_int <- read.csv(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/asignacion_obtenida_pace_interim_completando_con_finales.csv", sep=''), header=TRUE, sep=';')

reg_fin <- read.csv(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/asignacion_obtenida_reg_finales.csv", sep=''), header=TRUE, sep=';')
bea_fin <- read.csv(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/asignacion_obtenida_bea_finales.csv", sep=''), header=TRUE, sep=';')
pace_fin <- read.csv(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/asignacion_obtenida_pace_finales.csv", sep=''), header=TRUE, sep=';')
```

```{r}
pace_int_a <- pace_int %>% filter(marca == 24)
bea_int_a  <- bea_int %>% filter(marca == 24 & !(id_alumno %in% pace_int_a$id_alumno))
ass_int <- rbind(pace_int_a, bea_int_a)
ass_int <- rbind(ass_int, reg_int %>% filter(marca == 24 & !(id_alumno %in% ass_int$id_alumno) ))

pace_fin_a <- pace_fin %>% filter(marca == 24)
bea_fin_a  <- bea_fin %>% filter(marca == 24 & !(id_alumno %in% pace_fin_a$id_alumno))
ass_fin <- rbind(pace_fin_a, bea_fin_a)
ass_fin <- rbind(ass_fin, reg_fin %>% filter(marca == 24 & !(id_alumno %in% ass_fin$id_alumno) ))
```

```{r}
ass_int$assigned <- 1
ass_fin$assigned <- 1

rm(pace_int_a, bea_int_a, pace_fin_a, bea_fin_a)
```

```{r}
ass <- merge(ass_int %>% dplyr::select(id_alumno, codigo_carrera, pref, assigned) %>% dplyr::rename(codigo_carrera_assigned_int = codigo_carrera, pref_assigned_int = pref, assigned_int = assigned),
            ass_fin %>% dplyr::select(id_alumno, codigo_carrera, pref, assigned) %>% dplyr::rename(codigo_carrera_assigned_fin = codigo_carrera, pref_assigned_fin = pref, assigned_fin = assigned), by="id_alumno", all=TRUE)
```

```{r}
ass <- merge(ass, reg_int %>% dplyr::select(id_alumno, codigo_carrera, pref) %>% dplyr::rename(pref_assigned_fin_at_int = pref), by.x=c("id_alumno", "codigo_carrera_assigned_fin"), by.y=c("id_alumno", "codigo_carrera"), all.x=TRUE)
```

## Merge sources of data

```{r}
df <- merge(df, ass, by.x="MRUN", by.y="id_alumno", all.x=TRUE)
```

```{r}
df$assigned_oficial[is.na(df$assigned_oficial)] <- 0
df$assigned_int[is.na(df$assigned_int)] <- 0
df$assigned_fin[is.na(df$assigned_fin)] <- 0

df$codigo_carrera_assigned_int[is.na(df$codigo_carrera_assigned_int)] <- 0
df$codigo_carrera_assigned_fin[is.na(df$codigo_carrera_assigned_fin)] <- 0

df %<>% mutate(entered = ifelse(assigned_int == 0 & assigned_fin == 1 , 1, 0),
               entered = ifelse(assigned_int == 1 , NA, entered),
               left = ifelse(assigned_int == 1 & assigned_fin == 0, 1, 0),
               left = ifelse(assigned_int == 0, NA, left),
               changed_status_ass = ifelse(assigned_int != assigned_fin, 1, 0),
               changed_program_ass = ifelse(changed_status_ass == 0 & assigned_int == 1 &
                                             codigo_carrera_assigned_int != codigo_carrera_assigned_fin, 1, 0) )
```

```{r}
df$increased[is.na(df$increased)] <- 0
df$decreased[is.na(df$decreased)] <- 0

df$increased_valid[is.na(df$increased_valid)] <- 0
df$decreased_valid[is.na(df$decreased_valid)] <- 0
df$changed[is.na(df$changed)] <- 0
```

## Pre-processing of survey

```{r}
survey_mapping <- read.csv(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/survey/encuesta.csv", sep=''))
```

```{r}
survey_answers <- read_excel(paste(dropbox_dir,"Mistakes Structural/Data/Data_from_Mistakes_1/clean/survey-2022/survey answers/ans_surveymistakes.xlsx", sep=''))
```

```{r}
survey <- merge(survey_answers, survey_mapping, by.x="hash", by.y="llavespub")
```

```{r}
survey %<>% dplyr::select(mrun, QID8_11, QID131_11, QID12_2, QID95_1,
                          QID87_1, QID87_2, QID87_3, QID87_4, QID87_5, QID87_7, QID87_8, QID87_9, QID87_8_TEXT,
                          QID124, QID123_2, QID132_1,
                          QID25, QID26, QID125_1, QID125_2, QID125_3, QID125_4, QID125_5, QID125_6, QID125_7, QID125_7_TEXT,
                          QID161_1, QID162_1,
                          QID136_1, QID136_2, QID136_11, QID136_10,
                          QID137_1, QID137_2, QID137_11, QID137_10,
                          QID138_1, QID138_2, QID138_11, QID138_10,
                          QID25, QID26, QID26_4_TEXT,
                          QID27_1, QID27_2, QID27_5, QID27_6, QID27_5_TEXT,
                          QID150_2, QID25, QID27_1, QID27_2, QID27_5, QID27_5_TEXT, 
                          QID27_6, QID128_1,	QID128_2,	QID128_3,	QID128_4,	QID128_5,
                          QID134_1, QID134_2,	QID134_3,	QID134_4,	QID134_5,	QID135_1,	QID135_2,
                          QID135_3,	QID135_4,	QID135_5)
```

```{r}
survey %<>% dplyr::rename(prob_top_pref = QID8_11, prob_any_pref = QID131_11, codigo_carrera_top_true = QID12_2, puntpond_top_true = QID95_1,
                          bottom_true_any = QID124, codigo_carrera_bottom_true = QID123_2, puntpond_bottom_true = QID132_1,
                          puntpond_top_reported = QID161_1, puntpond_bottom_reported = QID162_1,
                          cutoff_prev_top_reported = QID136_1, cutoff_prev_bottom_reported = QID136_2, cutoff_prev_top_true = QID136_11, cutoff_prev_bottom_true = QID136_10,
                          cutoff_top_reported = QID137_1, cutoff_bottom_reported = QID137_2, cutoff_top_true = QID137_11, cutoff_bottom_true = QID137_10,
                          prob_top_reported = QID138_1, prob_bottom_reported = QID138_2, prob_top_true = QID138_11, prob_bottom_true = QID138_10,
                          knows_adm_mistake = QID25, reason_mistake = QID26,
                          single_choice = QID150_2)
```

```{r}
survey$codigo_carrera_top_true <- as.numeric(gsub("\\D", "", survey$codigo_carrera_top_true))
survey$codigo_carrera_bottom_true <- as.numeric(gsub("\\D", "", survey$codigo_carrera_bottom_true))
survey$codigo_carrera_single_choice <- as.numeric(gsub("\\D", "", survey$single_choice))
```

```{r}
survey %<>% mutate(bottom_true_any = ifelse(bottom_true_any == "S√≠", 1, ifelse(bottom_true_any == "No", 0, bottom_true_any)))

survey %<>% mutate(reason_skip_top_true = ifelse(!is.na(QID87_1), QID87_1,
                                                 ifelse(!is.na(QID87_2), QID87_2,
                                                        ifelse(!is.na(QID87_3), QID87_3,
                                                               ifelse(!is.na(QID87_4), QID87_4,
                                                                      ifelse(!is.na(QID87_5), QID87_5,
                                                                             ifelse(!is.na(QID87_7), QID87_7,
                                                                                    ifelse(!is.na(QID87_9), QID87_9,
                                                                                           ifelse(!is.na(QID87_8), QID87_8_TEXT, NA ) ) ) ) ) ))))

survey %<>% mutate(reason_skip_bottom_true = ifelse(!is.na(QID125_1), QID125_1,
                                                    ifelse(!is.na(QID125_2), QID125_2,
                                                           ifelse(!is.na(QID125_3), QID125_3,
                                                                  ifelse(!is.na(QID125_4), QID125_4,
                                                                         ifelse(!is.na(QID125_5), QID125_5,
                                                                                ifelse(!is.na(QID125_6), QID125_6,
                                                                                       ifelse(!is.na(QID125_7), QID125_7_TEXT, NA )) ) ) ) ) ) )

survey %<>% mutate(reason_uninformed_requisites = ifelse(!is.na(QID27_1), QID27_1,
                                                      ifelse(!is.na(QID27_2), QID27_2,
                                                             ifelse(!is.na(QID27_6), QID27_6,
                                                                    ifelse(!is.na(QID27_5), QID27_5_TEXT, NA ) ) ) ))

survey %<>% mutate(reason_mistake = ifelse(is.na(QID26_4_TEXT), reason_mistake,  QID26_4_TEXT) )
#TODO: In the script of survey 2021 we have some cleanings that have to be applied here
# regarding the definition of top-true preferences
#TODO: Ask the RA to double check that we are identifying the correct questions
# from the survey in the script and which questions have skips or missing values

#Defining inconsistent types depending of the reason they give to skip top-true programs or bottom-true programs







#TODO: FINISH THIS AND ADAPT IT TO BOTTOM TRUE

# Translate labels of reasons to English (not an exact translation)
# dfs_2021 %<>% mutate(reason_strategic_1 = ifelse(reason_strategic_1 == "Postul√© a mi carrera ideal en mi primera preferencia.",
#                                                  "(a) I did apply to my ideal program as a top-reported preference", ""),
#                      reason_strategic_2 = ifelse(reason_strategic_2 == "La probabilidad de que quede seleccionado en esa carrera es muy baja.",
#                                                  "(b) My admission probability to that program is too low", ""),
#                      reason_strategic_3 = ifelse(reason_strategic_3 == "La carrera me parece demasiado dif√≠cil y no creo que vaya a terminarla en caso de matricularme.",
#                                                  "(c) The program is too hard and I don't think I would be able to graduate from it", ""),
#                      reason_strategic_4 = ifelse(reason_strategic_4 == "No tengo los recursos econ√≥micos para pagar el costo de la carrera.",
#                                                  "(d) I do not have the monetary resources to pay for the program", ""),
#                      reason_strategic_5 = ifelse(reason_strategic_5 == "Para incluir mi carrera ideal tendr√≠a que excluir alguna de las carreras de mi postulaci√≥n.",
#                                                  "(e) To include my ideal program, I would have to exclude some program from my list", ""),
#                      reason_strategic_6 = ifelse(reason_strategic_6 == "La decisi√≥n de d√≥nde postular no dependi√≥ completamente de m√≠, y fue influenciada por otras personas (familia, amigos u otros).",
#                                                  "(f) The decision to where to apply did not depend only on me, and it was influenced by other people (family, friends, etc.)", ""),
#                      reason_strategic_7 = ifelse(reason_strategic_7 == "Pens√© que al incluir esta carrera en mi lista de preferencias habr√≠a reducido mis posibilidades de selecci√≥n en las dem√°s carreras.",
#                                                  "(g) I thought that by including this program in my list I would have reduced my chances of being admitted to the other listed programs", ""),
#                      reason_strategic_8 = ifelse(reason_strategic_8 == "Dado que mi probabilidad de selecci√≥n es muy baja, prefiero no postular y quedar seleccionado en una preferencia reportada m√°s alta.",
#                                                  "(h) Given that my admission chances are too low, I prefer to do not list this program and being assigned to a higher reported preference", ""))
#
# # Create variable to identify inconsistent answers to the survey
# dfs_2021 %<>% mutate(inconsistent_type = 0)
# dfs_2021 %<>% mutate(inconsistent_type = ifelse((((reason_strategic_1 == "") | (reason_strategic_3 != "") | (reason_strategic_4 != "")) & (truth_teller == 1)), 1, inconsistent_type))
# dfs_2021 %<>% mutate(inconsistent_type = ifelse(((reason_strategic_1 != "") | (reason_strategic_3 != "") | (reason_strategic_4 != "")) & (misreport_order == 1), 1, inconsistent_type))
# dfs_2021 %<>% mutate(inconsistent_type = ifelse(((reason_strategic_1 != "") | (reason_strategic_3 != "") | (reason_strategic_4 != "")) & (misreport_exclude == 1), 1, inconsistent_type))
#







```

QID8 <- prob assignment top pref
QID131 <- prob assignment in any preference
QID12_2 <- top true
QID95_1 <- punt pond in top true
QID87_1 to _8 <- reason for not including top true in ROL
QID124 <- any other program outside ROL (bottom true) yes/no
QID123_2 <- bottom_true
QID132_1 <- score at bottom true
QID125_1 to _TEXT <- reason for not including
QID161_1 <- score in trop reported
QID162_1 <- score in last reported
QID136_1 <- cutoff last year top reported
QID136_2 <- cutoff last year last reported
QID136_3 <- cutoff last year top true
QID136_4 <- cutoff last year bottom true
QID137_1 <- cutoff top reported
QID137_2 <- cutoff last reported
QID137_3 <- cutoff top true
QID137_4 <- cutoff bottom true
QID138_1 <- prob top reported
QID138_2 <- prob last reported
QID138_3 <- prob top true
QID138_4 <- prob bottom true
QID25 <- knowledge about adm mistakes (yes/no)
QID26 <- reason
QID27_1 to_text <- if didn't know the requisite, why
QID150_2 <- single choice

```{r}
survey$responded_survey <- 1
```

```{r}
survey <- readRDS(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/survey_processed.rds", sep=''))
tbp <- read.csv(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/preprocessing_top_and_bottom_true.csv", sep=''))
#NOTE: the probabilities here might be outdated, so we will drop them and use the new clean data from Nacho
tbp %<>% select(!starts_with("prob"))

sur <- merge(survey, tbp %>% dplyr::select(-c(codigo_carrera_top_true, codigo_carrera_bottom_true)), by="mrun", all.x=TRUE)

sur %<>% dplyr::rename(puntpond_top_true_belief = puntpond_top_true.x, puntpond_top_true = puntpond_top_true.y,
                        puntpond_bottom_true_belief = puntpond_bottom_true.x, puntpond_bottom_true = puntpond_bottom_true.y)

sur %<>% mutate(puntpond_top_true = as.numeric(puntpond_top_true)/100,
                puntpond_bottom_true = as.numeric(puntpond_bottom_true)/100,
                puntpond_top_true_belief = as.numeric(puntpond_top_true_belief),
                puntpond_bottom_true_belief = as.numeric(puntpond_bottom_true_belief),
                diff_puntpond_top_true = puntpond_top_true - puntpond_top_true_belief,
                diff_puntpond_bottom_true = puntpond_bottom_true - puntpond_bottom_true_belief)
# Merge with the clean probs computed by Nacho

```


# Analysis of Survey --------------------------

## Data

```{r}
#Read All probabilities with Ratex too (fixed)
probstrue <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/outputs/2022/probs_for_true_results_fixed_with_ratex.csv", sep=''), sep=',', header=TRUE)
probsofficial <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/outputs/2022/probs_for_official_results_fixed_with_ratex.csv", sep=''), sep=',', header=TRUE)
probspartial <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/outputs/2022/probs_for_partial_results_fixed_with_ratex.csv", sep=''), sep=',', header=TRUE)
#NOTE: probstrue has as pref 1 the top-true pref and pref 2 the bottom-true pref
probstrue %<>% dplyr::rename(codigo_carrera_top_true    = codigo_carrera_1,
                             marca_top_true             = marca_1 ,
                             puntpond_top_true          = puntpond_1 ,
                             prob_interim_top_true      = prob_interim_1 ,
                             prob_adaptive_top_true     = prob_adaptive_1 ,
                             prob_ratex_top_true        = prob_ratex_1,
                             codigo_carrera_bottom_true = codigo_carrera_2,
                             marca_bottom_true          = marca_2 ,
                             puntpond_bottom_true       = puntpond_2 ,
                             prob_interim_bottom_true   = prob_interim_2 ,
                             prob_adaptive_bottom_true  = prob_adaptive_2 ,
                             prob_ratex_bottom_true     = prob_ratex_2) %>%
                             select("MRUN",
                                    "codigo_carrera_top_true",
                                    "marca_top_true",
                                    "puntpond_top_true",
                                    "prob_interim_top_true",
                                    "prob_adaptive_top_true",
                                    "prob_ratex_top_true",
                                    "codigo_carrera_bottom_true",
                                    "marca_bottom_true",
                                    "puntpond_bottom_true",
                                    "prob_interim_bottom_true",
                                    "prob_adaptive_bottom_true",
                                    "prob_ratex_bottom_true")

```

```{r}
survey <- readRDS(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/survey_processed_with_probs.rds", sep=''))
#NOTE: this file has the subjective beliefs on probabilities (you can confirm this becaise probs have round values)
# Merge survey with clean probs for toptrue and bottomtrue
survey = merge(survey, probstrue %>% select(!c("codigo_carrera_top_true", "codigo_carrera_bottom_true","marca_top_true",
                                               "puntpond_top_true", "marca_bottom_true", "puntpond_bottom_true")), by.x = "mrun", by.y = "MRUN", all.x = TRUE)

dof <- merge(probsofficial, survey, by.x="MRUN", by.y="mrun", all.x=TRUE)

dof %<>% mutate(responded_survey = ifelse(is.na(responded_survey), 0, responded_survey))
```

```{r}
of <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/data/2022/seleccion_20_01_22.csv", sep=''))
#TODO: Check if this takes into account or not the BEA or PACE assignment (I think it doesn't and we are assuming that too)
of_l <- reshape(of[,c(1,4:53)], direction='long',
                    varying=colnames(of[,4:53]),
                    times=c('01', '02', '03', '04', '05', '06', '07', '08', '09', '10'),
                    v.names=c('cod_carrera_pref', 'estado_pref','ptje_pref', 'lugar_pref', 'pond_acad_pref'),
                    idvar='mrun')
colnames(of_l) <- c("mrun", "pref", "codigo_carrera", "marca", "orden", "puntano", "puntpond") # this is just me not knowing how to use reshape
```

```{r}
car <- read.csv(paste(dropbox_dir, "/Mistakes Structural/Code/Python/Cartillas/data/2022/carreras_v2.csv", sep=''), header=TRUE, sep=";")
cutoffs <- of_l %>% filter(marca == 24) %>% group_by(codigo_carrera) %>% dplyr::summarise(num_admitted = n(), min_score = pmax(min(puntpond), 210.0))
car %<>% mutate(VACANTES_REG = VACANTES_1_SEMESTRE + VACANTES_2_SEMESTRE + SOBRECUPO_1_SEMESTRE + SOBRECUPO_2_SEMESTRE)
car <- merge(car, cutoffs, by.x="CODIGO_DEMRE", by.y="codigo_carrera", all.x=TRUE)
```

```{r}
pref_assignment <- of_l %>% filter(marca == 24) %>% dplyr::select(mrun, codigo_carrera) %>% dplyr::rename(MRUN = mrun, codigo_carrera_assigned = codigo_carrera)
```

```{r}
dof <- merge(dof, car %>% dplyr::select(CODIGO_DEMRE, VACANTES_REG, num_admitted, min_score) %>%
               mutate(min_score = ifelse(num_admitted < VACANTES_REG, 210.0, min_score)) %>%
               dplyr::rename(vacants_top_true = VACANTES_REG,
                             num_admitted_top_true = num_admitted,
                             min_score_top_true = min_score), by.x="codigo_carrera_top_true", by.y="CODIGO_DEMRE", all.x=TRUE)

dof <- merge(dof, car %>% dplyr::select(CODIGO_DEMRE, VACANTES_REG, num_admitted, min_score) %>%
               mutate(min_score = ifelse(num_admitted < VACANTES_REG, 210.0, min_score)) %>%
               dplyr::rename(vacants_bottom_true = VACANTES_REG,
                             num_admitted_bottom_true = num_admitted,
                             min_score_bottom_true = min_score), by.x="codigo_carrera_bottom_true", by.y="CODIGO_DEMRE", all.x=TRUE)

dof <- merge(dof, car %>% dplyr::select(CODIGO_DEMRE, VACANTES_REG, num_admitted, min_score) %>%
               mutate(min_score = ifelse(num_admitted < VACANTES_REG, 210.0, min_score)) %>%
               dplyr::rename(vacants_single_choice = VACANTES_REG,
                             num_admitted_single_choice = num_admitted,
                             min_score_single_choice = min_score), by.x="codigo_carrera_single_choice", by.y="CODIGO_DEMRE", all.x=TRUE)


dof %<>% mutate(applied_to_top_true = ifelse(codigo_carrera_top_true == codigo_carrera_1 | codigo_carrera_top_true == codigo_carrera_2 |
                                              codigo_carrera_top_true == codigo_carrera_3 | codigo_carrera_top_true == codigo_carrera_4 |
                                              codigo_carrera_top_true == codigo_carrera_5 | codigo_carrera_top_true == codigo_carrera_6 |
                                              codigo_carrera_top_true == codigo_carrera_7 | codigo_carrera_top_true == codigo_carrera_8 |
                                              codigo_carrera_top_true == codigo_carrera_9 | codigo_carrera_top_true == codigo_carrera_10, 1, 0),
                applied_to_bottom_true= ifelse(codigo_carrera_bottom_true == codigo_carrera_1 | codigo_carrera_bottom_true == codigo_carrera_2 |
                                              codigo_carrera_bottom_true == codigo_carrera_3 | codigo_carrera_bottom_true == codigo_carrera_4 |
                                              codigo_carrera_bottom_true == codigo_carrera_5 | codigo_carrera_bottom_true == codigo_carrera_6 |
                                              codigo_carrera_bottom_true == codigo_carrera_7 | codigo_carrera_bottom_true == codigo_carrera_8 |
                                              codigo_carrera_bottom_true == codigo_carrera_9 | codigo_carrera_bottom_true == codigo_carrera_10, 1, 0),
                applied_to_single_choice = ifelse(codigo_carrera_single_choice == codigo_carrera_1 | codigo_carrera_single_choice == codigo_carrera_2 |
                                              codigo_carrera_single_choice == codigo_carrera_3 | codigo_carrera_single_choice == codigo_carrera_4 |
                                              codigo_carrera_single_choice == codigo_carrera_5 | codigo_carrera_single_choice == codigo_carrera_6 |
                                              codigo_carrera_single_choice == codigo_carrera_7 | codigo_carrera_single_choice == codigo_carrera_8 |
                                              codigo_carrera_single_choice == codigo_carrera_9 | codigo_carrera_single_choice == codigo_carrera_10, 1, 0) )

dof %<>% mutate(single_choice_is_top_true = ifelse(codigo_carrera_single_choice == codigo_carrera_top_true, 1, 0),
                single_choice_is_bottom_true = ifelse(codigo_carrera_single_choice == codigo_carrera_bottom_true, 1, 0), )

dof %<>% mutate(pref_of_single_choice = ifelse(applied_to_single_choice == 1,
                                               as.character((codigo_carrera_single_choice == codigo_carrera_1)*1 + (codigo_carrera_single_choice == codigo_carrera_2)*2 +
                                                 (codigo_carrera_single_choice == codigo_carrera_3)*3 + (codigo_carrera_single_choice == codigo_carrera_4)*4 +
                                                 (codigo_carrera_single_choice == codigo_carrera_5)*5 + (codigo_carrera_single_choice == codigo_carrera_6)*6 +
                                                 (codigo_carrera_single_choice == codigo_carrera_7)*7 + (codigo_carrera_single_choice == codigo_carrera_8)*8 +
                                                 (codigo_carrera_single_choice == codigo_carrera_9)*9 + (codigo_carrera_single_choice == codigo_carrera_10)*10),
                                               ifelse(single_choice_is_top_true == 1, "TT",
                                                      ifelse(single_choice_is_bottom_true == 1, "BT",
                                                             ifelse(!is.na(codigo_carrera_single_choice), "Other", "NR")) ) ))

dof$pref_of_single_choice[is.na(dof$pref_of_single_choice)] <- "NR"

dof$pref_of_single_choice <- factor(dof$pref_of_single_choice, levels = c("1", "2", "3", "4", "5", "6", "7", "8", "9", "10", "TT", "BT", "Other", "NR"))

```

```{r}
dof <- merge(dof, pref_assignment, by="MRUN", all.x=TRUE)
```

```{r}
dof %>% group_by(codigo_carrera_assigned == codigo_carrera_single_choice) %>% tally()
```

```{r}
my_colors <- RColorBrewer::brewer.pal(4, "Pastel1")[1:2]
myblue = '#2F5597'
```





# Analysis of RCT + survey --------------------------

Note:
- Probabilities for the interim porfolios come from the RCT, i.e., with partial applications and randomly completing the market.
- Probabilities for the final porfolios come from doing bootstrap with final applications. This is not consistent; we should use the same probabilities for interim and final portfolios. Must likely we should use rational expectations considering the final applications.
- Probabilities for the top and bottom true preferences are evaluated using partial applications + market randomly completed.

## Data


```{r}
#Read All probabilities with Ratex too (fixed)
probstrue <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/outputs/2022/probs_for_true_results_fixed_with_ratex.csv", sep=''), sep=',', header=TRUE)
probsofficial <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/outputs/2022/probs_for_official_results_fixed_with_ratex.csv", sep=''), sep=',', header=TRUE)
probspartial <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/outputs/2022/probs_for_partial_results_fixed_with_ratex.csv", sep=''), sep=',', header=TRUE)
#NOTE: probstrue has as pref 1 the top-true pref and pref 2 the bottom-true pref

```


```{r}
df <- readRDS(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/master_file_for_analysis_of_rct.csv", sep=''))
#NOTE: probstrue has as pref 1 the top-true pref and pref 2 the bottom-true pref
probstrue %<>% dplyr::rename(codigo_carrera_top_true    = codigo_carrera_1,
                             marca_top_true             = marca_1 ,
                             puntpond_top_true          = puntpond_1 ,
                             prob_interim_top_true      = prob_interim_1 ,
                             prob_adaptive_top_true     = prob_adaptive_1 ,
                             prob_ratex_top_true        = prob_ratex_1,
                             codigo_carrera_bottom_true = codigo_carrera_2,
                             marca_bottom_true          = marca_2 ,
                             puntpond_bottom_true       = puntpond_2 ,
                             prob_interim_bottom_true   = prob_interim_2 ,
                             prob_adaptive_bottom_true  = prob_adaptive_2 ,
                             prob_ratex_bottom_true     = prob_ratex_2) %>%
                             select("MRUN",
                                    "codigo_carrera_top_true",
                                    "marca_top_true",
                                    "puntpond_top_true",
                                    "prob_interim_top_true",
                                    "prob_adaptive_top_true",
                                    "prob_ratex_top_true",
                                    "codigo_carrera_bottom_true",
                                    "marca_bottom_true",
                                    "puntpond_bottom_true",
                                    "prob_interim_bottom_true",
                                    "prob_adaptive_bottom_true",
                                    "prob_ratex_bottom_true")

survey <- readRDS(paste(dropbox_dir,"Mistakes Structural/Code/Python/Cartillas/outputs/2022/survey_processed_with_probs.rds", sep=''))
#NOTE: this file has the subjective beliefs on probabilities (you can confirm this becaise probs have round values)
# Merge survey with clean probs for toptrue and bottomtrue
survey = merge(survey, probstrue %>% select(!c("codigo_carrera_top_true", "codigo_carrera_bottom_true","marca_top_true",
                                               "puntpond_top_true", "marca_bottom_true", "puntpond_bottom_true")), by.x = "mrun", by.y = "MRUN", all.x = TRUE)

dof <- merge(df, survey, by.x="MRUN", by.y="mrun", all.x=TRUE)
dof <- merge(dof, probsofficial %>% dplyr::select(MRUN,
                                       overall_interim, overall_adaptive, overall_ratex,
                                       prob_interim_1, prob_adaptive_1, prob_ratex_1,
                                       prob_interim_2, prob_adaptive_2, prob_ratex_2,
                                       prob_interim_3, prob_adaptive_3, prob_ratex_3,
                                       prob_interim_4, prob_adaptive_4, prob_ratex_4,
                                       prob_interim_5, prob_adaptive_5, prob_ratex_5,
                                       prob_interim_6, prob_adaptive_6, prob_ratex_6,
                                       prob_interim_7, prob_adaptive_7, prob_ratex_7,
                                       prob_interim_8, prob_adaptive_8, prob_ratex_8,
                                       prob_interim_9, prob_adaptive_9, prob_ratex_9,
                                       prob_interim_10, prob_adaptive_10,  prob_ratex_10 ) %>%
               dplyr::rename(
                             overall_prob_interim_fin = overall_interim,
                             overall_prob_adaptive_fin = overall_adaptive,
                             overall_prob_ratex_fin = overall_ratex,
                             prob_interim_1_fin  = prob_interim_1, prob_adaptive_1_fin   = prob_adaptive_1,  prob_ratex_1_fin   = prob_ratex_1,
                             prob_interim_2_fin  = prob_interim_2, prob_adaptive_2_fin   = prob_adaptive_2,  prob_ratex_2_fin   = prob_ratex_2,
                             prob_interim_3_fin  = prob_interim_3, prob_adaptive_3_fin   = prob_adaptive_3,  prob_ratex_3_fin   = prob_ratex_3,
                             prob_interim_4_fin  = prob_interim_4, prob_adaptive_4_fin   = prob_adaptive_4,  prob_ratex_4_fin   = prob_ratex_4,
                             prob_interim_5_fin  = prob_interim_5, prob_adaptive_5_fin   = prob_adaptive_5,  prob_ratex_5_fin   = prob_ratex_5,
                             prob_interim_6_fin  = prob_interim_6, prob_adaptive_6_fin   = prob_adaptive_6,  prob_ratex_6_fin   = prob_ratex_6,
                             prob_interim_7_fin  = prob_interim_7, prob_adaptive_7_fin   = prob_adaptive_7,  prob_ratex_7_fin   = prob_ratex_7,
                             prob_interim_8_fin  = prob_interim_8, prob_adaptive_8_fin   = prob_adaptive_8,  prob_ratex_8_fin   = prob_ratex_8,
                             prob_interim_9_fin  = prob_interim_9, prob_adaptive_9_fin   = prob_adaptive_9,  prob_ratex_9_fin   = prob_ratex_9,
                             prob_interim_10_fin = prob_interim_10, prob_adaptive_10_fin = prob_adaptive_10, prob_ratex_10_fin  = prob_ratex_10  ),
             by="MRUN", all.x=TRUE)

#  Add probabilities for partial portfolios (before the intervention)
dof <- merge(dof, probspartial %>% dplyr::select(MRUN,
                                              overall_interim, overall_adaptive, overall_ratex,
                                              prob_interim_1, prob_adaptive_1, prob_ratex_1,
                                              prob_interim_2, prob_adaptive_2, prob_ratex_2,
                                              prob_interim_3, prob_adaptive_3, prob_ratex_3,
                                              prob_interim_4, prob_adaptive_4, prob_ratex_4,
                                              prob_interim_5, prob_adaptive_5, prob_ratex_5,
                                              prob_interim_6, prob_adaptive_6, prob_ratex_6,
                                              prob_interim_7, prob_adaptive_7, prob_ratex_7,
                                              prob_interim_8, prob_adaptive_8, prob_ratex_8,
                                              prob_interim_9, prob_adaptive_9, prob_ratex_9,
                                              prob_interim_10, prob_adaptive_10,  prob_ratex_10 ) %>%
                            dplyr::rename(overall_prob_interim_int = overall_interim,
                                          overall_prob_adaptive_int = overall_adaptive,
                                          overall_prob_ratex_int = overall_ratex,
                                          prob_interim_1_int  = prob_interim_1, prob_adaptive_1_int   = prob_adaptive_1,  prob_ratex_1_int   = prob_ratex_1,
                                          prob_interim_2_int  = prob_interim_2, prob_adaptive_2_int   = prob_adaptive_2,  prob_ratex_2_int   = prob_ratex_2,
                                          prob_interim_3_int  = prob_interim_3, prob_adaptive_3_int   = prob_adaptive_3,  prob_ratex_3_int   = prob_ratex_3,
                                          prob_interim_4_int  = prob_interim_4, prob_adaptive_4_int   = prob_adaptive_4,  prob_ratex_4_int   = prob_ratex_4,
                                          prob_interim_5_int  = prob_interim_5, prob_adaptive_5_int   = prob_adaptive_5,  prob_ratex_5_int   = prob_ratex_5,
                                          prob_interim_6_int  = prob_interim_6, prob_adaptive_6_int   = prob_adaptive_6,  prob_ratex_6_int   = prob_ratex_6,
                                          prob_interim_7_int  = prob_interim_7, prob_adaptive_7_int   = prob_adaptive_7,  prob_ratex_7_int   = prob_ratex_7,
                                          prob_interim_8_int  = prob_interim_8, prob_adaptive_8_int   = prob_adaptive_8,  prob_ratex_8_int   = prob_ratex_8,
                                          prob_interim_9_int  = prob_interim_9, prob_adaptive_9_int   = prob_adaptive_9,  prob_ratex_9_int   = prob_ratex_9,
                                          prob_interim_10_int = prob_interim_10, prob_adaptive_10_int = prob_adaptive_10, prob_ratex_10_int  = prob_ratex_10  ),
                          by="MRUN", all.x=TRUE)

dof %<>% mutate(responded_survey = ifelse(is.na(responded_survey), 0, responded_survey))

#TODO: notice that here we are using as a minimum score the value 0 (we need to change this to the
# maximum between minimum weighted score requirement and 210)
of <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/data/2022/seleccion_20_01_22.csv", sep=''))
car <- read.csv(paste(dropbox_dir, "/Mistakes Structural/Code/Python/Cartillas/data/2022/carreras_v2.csv", sep=''), header=TRUE, sep=";")

#NOTE: Be careful here that we are identifying the columns by their order
#TODO: We need to check that this order is correct
of_l <- reshape(of[,c(1,4:53)], direction='long',
                    varying=colnames(of[,4:53]),
                    times=c('01', '02', '03', '04', '05', '06', '07', '08', '09', '10'),
                    v.names=c('cod_carrera_pref', 'estado_pref','ptje_pref', 'lugar_pref', 'pond_acad_pref'),
                    idvar='mrun')
colnames(of_l) <- c("mrun", "pref", "codigo_carrera", "marca", "orden", "puntano", "puntpond") # this is just me not knowing how to use reshape

cutoffs <- of_l %>% filter(marca == 24) %>% group_by(codigo_carrera) %>% dplyr::summarise(num_admitted = n(), min_score = pmax(min(puntpond), 210.0))
car %<>% mutate(VACANTES_REG = VACANTES_1_SEMESTRE + VACANTES_2_SEMESTRE + SOBRECUPO_1_SEMESTRE + SOBRECUPO_2_SEMESTRE)
car <- merge(car, cutoffs, by.x="CODIGO_DEMRE", by.y="codigo_carrera", all.x=TRUE)

dof <- merge(dof, car %>% dplyr::select(CODIGO_DEMRE, VACANTES_REG, num_admitted, min_score) %>%
               mutate(min_score = ifelse(num_admitted < VACANTES_REG, 210.0, min_score)) %>%
               dplyr::rename(vacants_top_true = VACANTES_REG,
                             num_admitted_top_true = num_admitted,
                             min_score_top_true = min_score), by.x="codigo_carrera_top_true", by.y="CODIGO_DEMRE", all.x=TRUE)

dof <- merge(dof, car %>% dplyr::select(CODIGO_DEMRE, VACANTES_REG, num_admitted, min_score) %>%
               mutate(min_score = ifelse(num_admitted < VACANTES_REG, 210.0, min_score)) %>%
               dplyr::rename(vacants_bottom_true = VACANTES_REG,
                             num_admitted_bottom_true = num_admitted,
                             min_score_bottom_true = min_score), by.x="codigo_carrera_bottom_true", by.y="CODIGO_DEMRE", all.x=TRUE)


dof %<>% mutate(applied_to_top_true_int = ifelse(codigo_carrera_top_true == codigo_carrera_1_int | codigo_carrera_top_true == codigo_carrera_2_int |
                                              codigo_carrera_top_true == codigo_carrera_3_int | codigo_carrera_top_true == codigo_carrera_4_int |
                                              codigo_carrera_top_true == codigo_carrera_5_int | codigo_carrera_top_true == codigo_carrera_6_int |
                                              codigo_carrera_top_true == codigo_carrera_7_int | codigo_carrera_top_true == codigo_carrera_8_int |
                                              codigo_carrera_top_true == codigo_carrera_9_int | codigo_carrera_top_true == codigo_carrera_10_int, 1, 0),
                applied_to_bottom_true_int = ifelse(codigo_carrera_bottom_true == codigo_carrera_1_int | codigo_carrera_bottom_true == codigo_carrera_2_int |
                                              codigo_carrera_bottom_true == codigo_carrera_3_int | codigo_carrera_bottom_true == codigo_carrera_4_int |
                                              codigo_carrera_bottom_true == codigo_carrera_5_int | codigo_carrera_bottom_true == codigo_carrera_6_int |
                                              codigo_carrera_bottom_true == codigo_carrera_7_int | codigo_carrera_bottom_true == codigo_carrera_8_int |
                                              codigo_carrera_bottom_true == codigo_carrera_9_int | codigo_carrera_bottom_true == codigo_carrera_10_int, 1, 0))

dof %<>% mutate(applied_to_top_true_fin = ifelse(codigo_carrera_top_true == codigo_carrera_1_fin | codigo_carrera_top_true == codigo_carrera_2_fin |
                                              codigo_carrera_top_true == codigo_carrera_3_fin | codigo_carrera_top_true == codigo_carrera_4_fin |
                                              codigo_carrera_top_true == codigo_carrera_5_fin | codigo_carrera_top_true == codigo_carrera_6_fin |
                                              codigo_carrera_top_true == codigo_carrera_7_fin | codigo_carrera_top_true == codigo_carrera_8_fin |
                                              codigo_carrera_top_true == codigo_carrera_9_fin | codigo_carrera_top_true == codigo_carrera_10_fin, 1, 0),
                applied_to_bottom_true_fin = ifelse(codigo_carrera_bottom_true == codigo_carrera_1_fin | codigo_carrera_bottom_true == codigo_carrera_2_fin |
                                              codigo_carrera_bottom_true == codigo_carrera_3_fin | codigo_carrera_bottom_true == codigo_carrera_4_fin |
                                              codigo_carrera_bottom_true == codigo_carrera_5_fin | codigo_carrera_bottom_true == codigo_carrera_6_fin |
                                              codigo_carrera_bottom_true == codigo_carrera_7_fin | codigo_carrera_bottom_true == codigo_carrera_8_fin |
                                              codigo_carrera_bottom_true == codigo_carrera_9_fin | codigo_carrera_bottom_true == codigo_carrera_10_fin, 1, 0))

dof %<>% mutate(ordering_mistake_int = ifelse(applied_to_top_true_int == 1 & codigo_carrera_top_true != codigo_carrera_1_fin, 1, 0),
                ordering_mistake_fin = ifelse(applied_to_top_true_fin == 1 & codigo_carrera_top_true != codigo_carrera_1_fin, 1, 0))


#TODO: Check this code with Nacho seems wrong to me
# dof %<>% rowwise() %>% mutate(min_prob_adaptive_int = min(prob_adaptive_1_int + (codigo_carrera_1_int == 0), prob_adaptive_2_int + (codigo_carrera_2_int == 0),
#                                                       prob_adaptive_3_int + (codigo_carrera_3_int == 0), prob_adaptive_4_int + (codigo_carrera_4_int == 0),
#                                                       prob_adaptive_5_int + (codigo_carrera_5_int == 0), prob_adaptive_6_int + (codigo_carrera_6_int == 0),
#                                                       prob_adaptive_7_int + (codigo_carrera_7_int == 0), prob_adaptive_8_int + (codigo_carrera_8_int == 0),
#                                                       prob_adaptive_9_int + (codigo_carrera_9_int == 0), prob_adaptive_10_int + (codigo_carrera_10_int == 0)))

# dof %<>% rowwise() %>% mutate(min_prob_adaptive_fin = min(prob_adaptive_1_fin + (codigo_carrera_1_fin == 0), prob_adaptive_2_fin + (codigo_carrera_2_fin == 0),
#                                                       prob_adaptive_3_fin + (codigo_carrera_3_fin == 0), prob_adaptive_4_fin + (codigo_carrera_4_fin == 0),
#                                                       prob_adaptive_5_fin + (codigo_carrera_5_fin == 0), prob_adaptive_6_fin + (codigo_carrera_6_fin == 0),
#                                                       prob_adaptive_7_fin + (codigo_carrera_7_fin == 0), prob_adaptive_8_fin + (codigo_carrera_8_fin == 0),
#                                                       prob_adaptive_9_fin + (codigo_carrera_9_fin == 0), prob_adaptive_10_fin + (codigo_carrera_10_fin == 0)))

#TODO: Becareful with the sign here, it might not be consistent with the definitions in the paper
dof %<>% mutate(bias_in_belief_ratex_top_true    = as.numeric(prob_top_true) - as.numeric(prob_ratex_top_true)*100,
                bias_in_belief_ratex_bottom_true = as.numeric(prob_bottom_true) - as.numeric(prob_ratex_bottom_true)*100)
#TODO: review this definition
dof %<>% mutate(bias_in_belief_overall_ratex =  as.numeric(prob_any_pref) - as.numeric(overall_prob_ratex_fin)*100,
                bias_in_belief_risk_ratex =  (100 - as.numeric(prob_any_pref)) - (1 - as.numeric(overall_prob_ratex_fin))*100)
hist(dof$bias_in_belief_risk_ratex)
```

```{r}
# ELIMINAR PACES HABILITADOS
paces <- read.csv(paste(dropbox_dir, "Mistakes Structural/Code/Python/Cartillas/data/2022/habilitados_pace_v2.csv", sep=''), sep=',', header=TRUE, fileEncoding = 'UTF-8-BOM') #had to add fileencoding option
paces %<>% mutate(habilitado = ifelse(criterio_1 == 1 & criterio_2 == 1 & criterio_3 == 1, 1, 0))
paces_ids <- paces %>% filter(habilitado == 1) %>% pull(mrun)
dof %<>% filter(!(MRUN %in% paces_ids))
```




#Creating some mistake variables
```{r}
dof %<>% mutate(reduced_mistakes = ifelse(changed == 1 & valid_apps_before < valid_apps_after, 1, 0),
                not_increased_mistakes = ifelse(changed == 1 & valid_apps_before <= valid_apps_after, 1, 0),
               reduced_share_mistakes = ifelse(changed == 1 & valid_apps_before/apps_before < valid_apps_after/apps_after, 1, 0),
                 not_increased_share_mistakes = ifelse(changed == 1 & valid_apps_before/apps_before <= valid_apps_after/apps_after, 1, 0)) %>%
   mutate(overall_prob_ratex_inc = ifelse(overall_prob_ratex_fin > overall_prob_ratex_int, 1, 0),
                                risk_ratex_dec = ifelse((1 - overall_prob_ratex_fin) < (1- overall_prob_ratex_int), 1, 0),                                
          risk_ratex_inc = ifelse((1 - overall_prob_ratex_fin) > (1- overall_prob_ratex_int), 1, 0),
          risk_ratex_not_inc = ifelse((1 - overall_prob_ratex_fin) <= (1- overall_prob_ratex_int), 1, 0),
                                overall_prob_ratex_inc_abs = overall_prob_ratex_fin - overall_prob_ratex_int,
                                applied_to_top_true_fin_in_top_pref = ifelse(applied_to_top_true_fin == 1 & codigo_carrera_top_true == codigo_carrera_1_fin, 1, 0),
                                not_applied_to_top_true_fin_in_top_pref =  ifelse(applied_to_top_true_fin_in_top_pref == 1, 0, 1))

```

Balance of the survey:
```{r}
balance <- lm(data =  dof, formula= responded_survey ~ factor(treatment))
summary(balance)

balance <- lm(data =  dof, formula= responded_survey ~ factor(treatment) + assigned_oficial)
summary(balance)
```

```{r}
final = dof %>% subset(responded_survey==1)
rm(list=ls()[! ls() %in% c("final")])
#Share applying to top true:
table(final$applied_to_top_true_fin_in_top_pref)
table(final$responded_survey)

final %<>% mutate(truthtelling_survey =  ifelse(is.na(QID87_1) & is.na(QID87_2)  & is.na(QID87_3) & is.na(QID87_4) &
                                      is.na(QID87_5) & is.na(QID87_7) & is.na(QID87_9) & is.na(QID87_8)&
                                      is.na(QID87_8_TEXT), 1, 0))
final %<>% mutate(truthtelling_survey =  ifelse(is.na(codigo_carrera_top_true)==1, NA, truthtelling_survey))
table(final %>% select(truthtelling_survey, applied_to_top_true_fin_in_top_pref), useNA ="always")


final %<>% mutate(reason_skip_top_true_common = ifelse(!is.na(QID87_1), QID87_1,
                                                 ifelse(!is.na(QID87_2), QID87_2,
                                                        ifelse(!is.na(QID87_3), QID87_3,
                                                               ifelse(!is.na(QID87_4), QID87_4,
                                                                      ifelse(!is.na(QID87_5), QID87_5,
                                                                             ifelse(!is.na(QID87_7), QID87_7,
                                                                                    ifelse(!is.na(QID87_9), QID87_9,
                                                                                           ifelse(!is.na(QID87_8),QID87_8, NA)))))))))
final %<>% mutate(missing_reason = ifelse(is.na(QID87_1)==TRUE & is.na(QID87_2)==TRUE & is.na(QID87_3)==TRUE & is.na(QID87_4)==TRUE & is.na(QID87_5)==TRUE & is.na(QID87_7)==TRUE & is.na(QID87_8)==TRUE & is.na(QID87_8_TEXT)==TRUE & is.na(QID87_9)==TRUE, 1,0))

View(final %>% select(applied_to_top_true_fin_in_top_pref, QID87_1, QID87_2, QID87_3, QID87_4, QID87_5, QID87_7, QID87_9, QID87_8, QID87_8_TEXT))
View(final %>% subset(applied_to_top_true_fin_in_top_pref==0) %>% select(applied_to_top_true_fin_in_top_pref, QID87_1, QID87_2, QID87_3, QID87_4, QID87_5, QID87_7, QID87_9, QID87_8, QID87_8_TEXT,reason_skip_top_true_common))
table(final %>% subset(applied_to_top_true_fin_in_top_pref==0) %>% select(missing_reason))

#Identifying inconsistent types
final %<>% mutate(inconsistent_type = ifelse(((is.na(QID87_2 ) == FALSE) | (is.na(QID87_3 ) == FALSE)) & ((applied_to_top_true_fin == 1  & applied_to_top_true_fin_in_top_pref==0) | applied_to_top_true_fin == 0), 1, 0))
final %<>% mutate(inconsistent_type = ifelse(is.na(codigo_carrera_top_true)==TRUE, NA, inconsistent_type)) 
View(final %>% subset(is.na(codigo_carrera_top_true)==TRUE) %>% select(QID87_2,QID87_3, applied_to_top_true_fin_in_top_pref, applied_to_top_true_fin,inconsistent_type)  )


#View(final %>% select(QID87_1, QID87_2, QID87_3, QID87_4, QID87_5, QID87_7, QID87_8, QID87_9, QID87_8_TEXT))
table(final %>% select(applied_to_top_true_fin_in_top_pref), useNA = "always")
table(final %>% subset(inconsistent_type==0) %>% select(applied_to_top_true_fin_in_top_pref), useNA = "always")
nrow(final %>% subset(applied_to_top_true_fin_in_top_pref==0 & inconsistent_type==0))/nrow(final %>% subset(responded_survey==1 & is.na(codigo_carrera_top_true)==FALSE  & inconsistent_type==0))
table(final %>% subset(applied_to_top_true_fin_in_top_pref==0 & inconsistent_type==0) %>% select(prob_top_true), useNA="always")
table(final %>% subset(applied_to_top_true_fin_in_top_pref==0 & inconsistent_type==0) %>% select(prob_top_pref), useNA="always")
table(final %>% subset(applied_to_top_true_fin_in_top_pref==0) %>% select(QID87_1), useNA="always")
table(final %>% subset(applied_to_top_true_fin_in_top_pref==0 & inconsistent_type==0) %>% select(QID87_1), useNA="always")
nrow(final %>% subset(applied_to_top_true_fin_in_top_pref==0 & inconsistent_type==0 & is.na(QID87_1)==FALSE  & missing_reason==0) )/nrow(final %>% subset(responded_survey==1 & applied_to_top_true_fin_in_top_pref==0  & inconsistent_type==0 & missing_reason==0))

final %<>% mutate(lowscore=ifelse((( (str_detect(QID87_8_TEXT, "puntaje")==TRUE & is.na(QID87_8)==FALSE) | (is.na(QID87_1)==FALSE))), 1, 0))
final %<>% mutate(lowscore=ifelse(missing_reason==1, NA, lowscore))
table(final %>% subset(applied_to_top_true_fin_in_top_pref==0 & inconsistent_type==0) %>% select(lowscore), useNA="always")
nrow(final %>% subset(applied_to_top_true_fin_in_top_pref==0 & inconsistent_type==0 & lowscore==1  & missing_reason==0))/nrow(final %>% subset(responded_survey==1 & applied_to_top_true_fin_in_top_pref==0  & inconsistent_type==0 & missing_reason==0))
View(final %>% subset(applied_to_top_true_fin_in_top_pref==0 & inconsistent_type==0) %>% select(applied_to_top_true_fin_in_top_pref, QID87_1, QID87_2, QID87_3, QID87_4, QID87_5, QID87_7, QID87_9, QID87_8, QID87_8_TEXT, missing_reason, lowscore))

final %<>% mutate(lowscore_bis=ifelse( (str_detect(QID87_8_TEXT, "puntaje")==TRUE & is.na(QID87_8)==FALSE) | (is.na(QID87_1)==FALSE & missing_reason==0)  | (as.numeric(prob_top_true)==0.00), 1, 0))
table(final %>% subset(applied_to_top_true_fin_in_top_pref==0 & inconsistent_type==0) %>% select(lowscore_bis), useNA="always")
4855/(4855+900)


table(final$bottom_true_any)
table(final %>% select(bottom_true_any) )
table(final %>% subset(overall_prob_ratex_fin<1.00) %>% select(bottom_true_any) )
table(final$bottom_true_any)

View(final %>% subset(overall_prob_ratex_fin<1.00) %>%  select(bottom_true_any, overall_prob_ratex_fin))

```

