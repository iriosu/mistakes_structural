---
title: "Untitled"
output: html_document
---

```{r}
library(dplyr)
library(tidyr)
library(magrittr)
library(AER)
library(stargazer)
library(ggplot2)
library(knitr) 
library(kableExtra)
library(magick)
library(devtools)
library(plm)
library(clubSandwich)
library(MatchIt)
library(stringr)
library(fixest)
```


# Load data
```{r}
df <- read.csv("/Users/iriosu/Dropbox/Mistakes/Code/Python/Cartillas/data/2021/210217 Reporte Postulaciones MRUN v2 CB.csv", header=TRUE, sep=',')
df <- separate(data = df, col = FECHA_POSTULACION, into=c("FECHA", "HORA"), sep=" ")
```

```{r}
df %<>% mutate(after_intervention = ifelse((FECHA == '2021-02-14' & strptime(HORA, "%H:%M") >= strptime("11:49", "%H:%M") |
                                           (FECHA > '2021-02-14')   ) , 1, 0))
```


```{r}
before <- df %>% filter(after_intervention == 0) %>% group_by(MRUN) %>% dplyr::slice(which.max(FOLIO_POSTULACION)) %>% dplyr::select(MRUN, CAR_CODIGO_1PREFER, CAR_CODIGO_2PREFER, CAR_CODIGO_3PREFER, CAR_CODIGO_4PREFER, CAR_CODIGO_5PREFER, CAR_CODIGO_6PREFER, CAR_CODIGO_7PREFER, CAR_CODIGO_8PREFER, CAR_CODIGO_9PREFER, CAR_CODIGO_10PREFER)
colnames(before) <- c("MRUN","CAR_CODIGO_1PREFER_before", "CAR_CODIGO_2PREFER_before", "CAR_CODIGO_3PREFER_before", "CAR_CODIGO_4PREFER_before", "CAR_CODIGO_5PREFER_before", "CAR_CODIGO_6PREFER_before", "CAR_CODIGO_7PREFER_before", "CAR_CODIGO_8PREFER_before", "CAR_CODIGO_9PREFER_before", "CAR_CODIGO_10PREFER_before")
```

```{r}
after <- df %>% filter(after_intervention == 1) %>% group_by(MRUN) %>% dplyr::slice(which.max(FOLIO_POSTULACION)) %>% dplyr::select(MRUN, CAR_CODIGO_1PREFER, CAR_CODIGO_2PREFER, CAR_CODIGO_3PREFER, CAR_CODIGO_4PREFER, CAR_CODIGO_5PREFER, CAR_CODIGO_6PREFER, CAR_CODIGO_7PREFER, CAR_CODIGO_8PREFER, CAR_CODIGO_9PREFER, CAR_CODIGO_10PREFER)
colnames(after) <- c("MRUN", "CAR_CODIGO_1PREFER_after", "CAR_CODIGO_2PREFER_after", "CAR_CODIGO_3PREFER_after", "CAR_CODIGO_4PREFER_after", "CAR_CODIGO_5PREFER_after", "CAR_CODIGO_6PREFER_after", "CAR_CODIGO_7PREFER_after", "CAR_CODIGO_8PREFER_after", "CAR_CODIGO_9PREFER_after", "CAR_CODIGO_10PREFER_after")
```

```{r}
colnames(df)
```


```{r}
last <- df %>% group_by(MRUN) %>% dplyr::slice(which.max(FOLIO_POSTULACION)) %>% dplyr::select(MRUN, FOLIO_POSTULACION, FECHA, CAR_CODIGO_1PREFER, CAR_CODIGO_2PREFER, CAR_CODIGO_3PREFER, CAR_CODIGO_4PREFER, CAR_CODIGO_5PREFER, CAR_CODIGO_6PREFER, CAR_CODIGO_7PREFER, CAR_CODIGO_8PREFER, CAR_CODIGO_9PREFER, CAR_CODIGO_10PREFER, ESTADO_POSTULACION, PUNTAJE_CARR1, PUNTAJE_CARR2, PUNTAJE_CARR3, PUNTAJE_CARR4, PUNTAJE_CARR5, PUNTAJE_CARR6, PUNTAJE_CARR7, PUNTAJE_CARR8, PUNTAJE_CARR9, PUNTAJE_CARR10)
```

```{r}
write.csv(last, "/Users/iriosu/Dropbox/Mistakes/Code/Python/Cartillas/data/2021/Reporte_diario_postulaciones_last_mrun.csv", row.names=FALSE)
```



```{r}
last <- df %>% group_by(MRUN) %>% dplyr::slice(which.max(FOLIO_POSTULACION)) %>% dplyr::select(MRUN, FOLIO_POSTULACION, FECHA, CAR_CODIGO_1PREFER, CAR_CODIGO_2PREFER, CAR_CODIGO_3PREFER, CAR_CODIGO_4PREFER, CAR_CODIGO_5PREFER, CAR_CODIGO_6PREFER, CAR_CODIGO_7PREFER, CAR_CODIGO_8PREFER, CAR_CODIGO_9PREFER, CAR_CODIGO_10PREFER, ESTADO_POSTULACION, PUNTAJE_CARR1, PUNTAJE_CARR2, PUNTAJE_CARR3, PUNTAJE_CARR4, PUNTAJE_CARR5, PUNTAJE_CARR6, PUNTAJE_CARR7, PUNTAJE_CARR8, PUNTAJE_CARR9, PUNTAJE_CARR10)
```

```{r}
before_to_merge <- df %>% filter(after_intervention == 0) %>% group_by(MRUN) %>% dplyr::slice(which.max(FOLIO_POSTULACION)) %>% dplyr::select(MRUN, FOLIO_POSTULACION, FECHA, CAR_CODIGO_1PREFER, CAR_CODIGO_2PREFER, CAR_CODIGO_3PREFER, CAR_CODIGO_4PREFER, CAR_CODIGO_5PREFER, CAR_CODIGO_6PREFER, CAR_CODIGO_7PREFER, CAR_CODIGO_8PREFER, CAR_CODIGO_9PREFER, CAR_CODIGO_10PREFER, ESTADO_POSTULACION, PUNTAJE_CARR1, PUNTAJE_CARR2, PUNTAJE_CARR3, PUNTAJE_CARR4, PUNTAJE_CARR5, PUNTAJE_CARR6, PUNTAJE_CARR7, PUNTAJE_CARR8, PUNTAJE_CARR9, PUNTAJE_CARR10)
```


```{r}
last_to_merge <- last %>% filter(!(MRUN %in% before_to_merge$MRUN))
```

```{r}
full_with_before <- rbind(before_to_merge, last_to_merge)
```

```{r}
write.csv(full_with_before, "/Users/iriosu/Dropbox/Mistakes/Code/Python/Cartillas/data/2021/Reporte_diario_postulaciones_before_merged_last_mrun.csv", row.names=FALSE)
```



```{r}
mg <- merge(before, after, by="MRUN")
```

```{r}
saveRDS(mg,"/Users/iriosu/Dropbox/Mistakes/Code/R/analysis warnings/Data/application_before_and_after.rds")
```

```{r}
load("/Users/iriosu/Dropbox/Mistakes/Code/R/analysis warnings/Data/AppList.Rdata")
load("/Users/iriosu/Dropbox/Mistakes/Code/R/analysis warnings/Data/appRCT.Rdata")
load("/Users/iriosu/Dropbox/Mistakes/Code/R/analysis warnings/Data/Falta_PorAbrir_List.Rdata")
```

```{r}
fpa <- Falta_PorAbrir_List
colnames(fpa) <- c("MRUN")
```

```{r}
probs <- read.csv("/Users/iriosu/Dropbox/Mistakes/Code/Python/Cartillas/outputs/2021/applications_and_probs.csv", header=TRUE, sep=';')
probs %<>% mutate(any_low_prob = ifelse( prob_level_1 == 1 |
                                          prob_level_2 == 1 |
                                          prob_level_3 == 1 |
                                          prob_level_4 == 1 |
                                          prob_level_5 == 1 |
                                          prob_level_6 == 1 |
                                          prob_level_7 == 1 |
                                          prob_level_8 == 1 |
                                          prob_level_9 == 1 |
                                          prob_level_10 == 1, 1, 0))
```

```{r}
probs_last <- read.csv("/Users/iriosu/Dropbox/Mistakes/Code/Python/Cartillas/outputs/2021/applications_and_probs_last.csv", header=TRUE, sep=';')
probs_last %<>% mutate(any_low_prob = ifelse( prob_level_1 == 1 |
                                          prob_level_2 == 1 |
                                          prob_level_3 == 1 |
                                          prob_level_4 == 1 |
                                          prob_level_5 == 1 |
                                          prob_level_6 == 1 |
                                          prob_level_7 == 1 |
                                          prob_level_8 == 1 |
                                          prob_level_9 == 1 |
                                          prob_level_10 == 1, 1, 0))
```

```{r}
probs %<>% mutate(num_alerts = prob_level_1 + prob_level_2 + prob_level_3 + prob_level_4 + prob_level_5 + prob_level_6 + prob_level_7 + prob_level_8 + prob_level_9 + prob_level_10)
```

```{r}
probs_last %<>% mutate(num_alerts = prob_level_1 + prob_level_2 + prob_level_3 + prob_level_4 + prob_level_5 + prob_level_6 + prob_level_7 + prob_level_8 + prob_level_9 + prob_level_10)
```







# Preprocessing of data

```{r}
ta <- appList %>% filter(!is.na(Treatment)) %>% filter(Treatment <= 2)
fpa$view <- 0

ta <- merge(ta, fpa, by.x="mrun", by.y="MRUN", all.x=TRUE)
ta$view[is.na(ta$view)] <- 1
```


Agregar estudiantes que modificaron su postulacion, es decir, que postularon antes de despues del envio de la cartilla.

```{r}
ta <- merge(ta, before, by.x="mrun", by.y="MRUN", all.x=TRUE)
ta <- merge(ta, after, by.x="mrun", by.y="MRUN", all.x=TRUE)
ta %<>% mutate(applied_before = ifelse(mrun %in% before$MRUN, 1, 0), 
               applied_after = ifelse(mrun %in% after$MRUN, 1, 0))
```

```{r}
ta <- merge(ta, probs[,c("MRUN", "any_low_prob", "overall_prob", "num_alerts")], by.x="mrun", by.y="MRUN", all.x=TRUE)
ta %<>% dplyr::rename(any_low_prob_before = any_low_prob,  overall_prob_before = overall_prob, num_alerts_before = num_alerts )
ta[is.na(ta)] <- 0
ta[ta == -1] <- 0

ta <- merge(ta, probs_last[,c("MRUN", "any_low_prob", "overall_prob")], by.x="mrun", by.y="MRUN", all.x=TRUE)
ta %<>% dplyr::rename(any_low_prob_after = any_low_prob,  overall_prob_after = overall_prob, num_alerts_after = num_alerts )
ta[is.na(ta)] <- 0
ta[ta == -1] <- 0
```

```{r}
ta %<>% mutate(n_apps_before = (CAR_CODIGO_1PREFER_before > 0) + (CAR_CODIGO_2PREFER_before > 0) + 
                                (CAR_CODIGO_3PREFER_before > 0) + (CAR_CODIGO_4PREFER_before > 0) +
                                (CAR_CODIGO_5PREFER_before > 0) + (CAR_CODIGO_6PREFER_before > 0) +
                                (CAR_CODIGO_7PREFER_before > 0) + (CAR_CODIGO_8PREFER_before > 0) +
                                (CAR_CODIGO_9PREFER_before > 0) + (CAR_CODIGO_10PREFER_before > 0), 
                n_apps_after = (CAR_CODIGO_1PREFER_after > 0) + (CAR_CODIGO_2PREFER_after > 0) + 
                                (CAR_CODIGO_3PREFER_after > 0) + (CAR_CODIGO_4PREFER_after > 0) +
                                (CAR_CODIGO_5PREFER_after > 0) + (CAR_CODIGO_6PREFER_after > 0) +
                                (CAR_CODIGO_7PREFER_after > 0) + (CAR_CODIGO_8PREFER_after > 0) +
                                (CAR_CODIGO_9PREFER_after > 0) + (CAR_CODIGO_10PREFER_after > 0))
```

```{r}
ta %>% group_by(Treatment) %>% summarise(n=n(), views = sum(view))
```

```{r}
car21 <- read.csv("/Users/iriosu/Dropbox/Mistakes/Code/Python/Cartillas/data/2021/carreras.csv", sep=';', header=TRUE)
car21$CODU <- substr(car21$CODIGO, 1, 2)
u_names <- car21 %>% distinct(UNIVERSIDAD, CODU)
codus <- unique(car21$CODU)
```

```{r}
for(codu in codus){
  print(codu)
  col1 <- paste("postulo_before_", codu, sep="")
  col2 <- paste("postulaciones_before_", codu, sep="")
  col3 <- paste("postulo_after_", codu, sep="")
  col4 <- paste("postulaciones_after_", codu, sep="")  
  codu <- as.numeric(codu)
  ta %<>% mutate(aux2 = (as.numeric(substr(CAR_CODIGO_1PREFER_before, 1, 2)) == codu) + (as.numeric(substr(CAR_CODIGO_2PREFER_before, 1, 2)) == codu) + 
                            (as.numeric(substr(CAR_CODIGO_3PREFER_before, 1, 2)) == codu) + (as.numeric(substr(CAR_CODIGO_4PREFER_before, 1, 2)) == codu) +
                            (as.numeric(substr(CAR_CODIGO_5PREFER_before, 1, 2)) == codu) + (as.numeric(substr(CAR_CODIGO_6PREFER_before, 1, 2)) == codu) +
                            (as.numeric(substr(CAR_CODIGO_7PREFER_before, 1, 2)) == codu) + (as.numeric(substr(CAR_CODIGO_8PREFER_before, 1, 2)) == codu) +
                            (as.numeric(substr(CAR_CODIGO_9PREFER_before, 1, 2)) == codu) + (as.numeric(substr(CAR_CODIGO_10PREFER_before, 1, 2)) == codu), 
                 aux4 = (as.numeric(substr(CAR_CODIGO_1PREFER_after, 1, 2)) == codu) + (as.numeric(substr(CAR_CODIGO_2PREFER_after, 1, 2)) == codu) + 
                            (as.numeric(substr(CAR_CODIGO_3PREFER_after, 1, 2)) == codu) + (as.numeric(substr(CAR_CODIGO_4PREFER_after, 1, 2)) == codu) +
                            (as.numeric(substr(CAR_CODIGO_5PREFER_after, 1, 2)) == codu) + (as.numeric(substr(CAR_CODIGO_6PREFER_after, 1, 2)) == codu) +
                            (as.numeric(substr(CAR_CODIGO_7PREFER_after, 1, 2)) == codu) + (as.numeric(substr(CAR_CODIGO_8PREFER_after, 1, 2)) == codu) +
                            (as.numeric(substr(CAR_CODIGO_9PREFER_after, 1, 2)) == codu) + (as.numeric(substr(CAR_CODIGO_10PREFER_after, 1, 2)) == codu))
  ta %<>% mutate(aux1 = ifelse(aux2 > 0, 1, 0), aux3 = ifelse(aux4 > 0, 1, 0))
  names(ta)[names(ta) == "aux1"] <- col1
  names(ta)[names(ta) == "aux2"] <- col2
  names(ta)[names(ta) == "aux3"] <- col3
  names(ta)[names(ta) == "aux4"] <- col4
}
```

```{r}
ta <- merge(ta, probs[,c("MRUN", "prob_level_1", "prob_level_2", "prob_level_3", "prob_level_4", "prob_level_5", 
                         "prob_level_6", "prob_level_7", "prob_level_8", "prob_level_9", "prob_level_10")], by.x="mrun", by.y="MRUN", all.x=TRUE)
```

```{r}
ta %<>% mutate(removed_1 = ifelse(CAR_CODIGO_1PREFER_before == 0, 0, 
                                  ifelse(CAR_CODIGO_1PREFER_before != CAR_CODIGO_1PREFER_after & CAR_CODIGO_1PREFER_before != CAR_CODIGO_2PREFER_after &
                                           CAR_CODIGO_1PREFER_before != CAR_CODIGO_3PREFER_after & CAR_CODIGO_1PREFER_before != CAR_CODIGO_4PREFER_after & 
                                           CAR_CODIGO_1PREFER_before != CAR_CODIGO_5PREFER_after & CAR_CODIGO_1PREFER_before != CAR_CODIGO_6PREFER_after & 
                                           CAR_CODIGO_1PREFER_before != CAR_CODIGO_7PREFER_after & CAR_CODIGO_1PREFER_before != CAR_CODIGO_8PREFER_after & 
                                           CAR_CODIGO_1PREFER_before != CAR_CODIGO_9PREFER_after & CAR_CODIGO_1PREFER_before != CAR_CODIGO_10PREFER_after, 1, 0)), 
               removed_2 = ifelse(CAR_CODIGO_2PREFER_before == 0, 0, 
                                  ifelse(CAR_CODIGO_2PREFER_before != CAR_CODIGO_1PREFER_after & CAR_CODIGO_2PREFER_before != CAR_CODIGO_2PREFER_after &
                                           CAR_CODIGO_2PREFER_before != CAR_CODIGO_3PREFER_after & CAR_CODIGO_2PREFER_before != CAR_CODIGO_4PREFER_after & 
                                           CAR_CODIGO_2PREFER_before != CAR_CODIGO_5PREFER_after & CAR_CODIGO_2PREFER_before != CAR_CODIGO_6PREFER_after & 
                                           CAR_CODIGO_2PREFER_before != CAR_CODIGO_7PREFER_after & CAR_CODIGO_2PREFER_before != CAR_CODIGO_8PREFER_after & 
                                           CAR_CODIGO_2PREFER_before != CAR_CODIGO_9PREFER_after & CAR_CODIGO_2PREFER_before != CAR_CODIGO_10PREFER_after, 1, 0)), 
               removed_3 = ifelse(CAR_CODIGO_3PREFER_before == 0, 0, 
                                  ifelse(CAR_CODIGO_3PREFER_before != CAR_CODIGO_1PREFER_after & CAR_CODIGO_3PREFER_before != CAR_CODIGO_2PREFER_after &
                                           CAR_CODIGO_3PREFER_before != CAR_CODIGO_3PREFER_after & CAR_CODIGO_3PREFER_before != CAR_CODIGO_4PREFER_after & 
                                           CAR_CODIGO_3PREFER_before != CAR_CODIGO_5PREFER_after & CAR_CODIGO_3PREFER_before != CAR_CODIGO_6PREFER_after & 
                                           CAR_CODIGO_3PREFER_before != CAR_CODIGO_7PREFER_after & CAR_CODIGO_3PREFER_before != CAR_CODIGO_8PREFER_after & 
                                           CAR_CODIGO_3PREFER_before != CAR_CODIGO_9PREFER_after & CAR_CODIGO_3PREFER_before != CAR_CODIGO_10PREFER_after, 1, 0)), 
               removed_4 = ifelse(CAR_CODIGO_4PREFER_before == 0, 0, 
                                  ifelse(CAR_CODIGO_4PREFER_before != CAR_CODIGO_1PREFER_after & CAR_CODIGO_4PREFER_before != CAR_CODIGO_2PREFER_after &
                                           CAR_CODIGO_4PREFER_before != CAR_CODIGO_3PREFER_after & CAR_CODIGO_4PREFER_before != CAR_CODIGO_4PREFER_after & 
                                           CAR_CODIGO_4PREFER_before != CAR_CODIGO_5PREFER_after & CAR_CODIGO_4PREFER_before != CAR_CODIGO_6PREFER_after & 
                                           CAR_CODIGO_4PREFER_before != CAR_CODIGO_7PREFER_after & CAR_CODIGO_4PREFER_before != CAR_CODIGO_8PREFER_after & 
                                           CAR_CODIGO_4PREFER_before != CAR_CODIGO_9PREFER_after & CAR_CODIGO_4PREFER_before != CAR_CODIGO_10PREFER_after, 1, 0)), 
               removed_5 = ifelse(CAR_CODIGO_5PREFER_before == 0, 0, 
                                  ifelse(CAR_CODIGO_5PREFER_before != CAR_CODIGO_1PREFER_after & CAR_CODIGO_5PREFER_before != CAR_CODIGO_2PREFER_after &
                                           CAR_CODIGO_5PREFER_before != CAR_CODIGO_3PREFER_after & CAR_CODIGO_5PREFER_before != CAR_CODIGO_4PREFER_after & 
                                           CAR_CODIGO_5PREFER_before != CAR_CODIGO_5PREFER_after & CAR_CODIGO_5PREFER_before != CAR_CODIGO_6PREFER_after & 
                                           CAR_CODIGO_5PREFER_before != CAR_CODIGO_7PREFER_after & CAR_CODIGO_5PREFER_before != CAR_CODIGO_8PREFER_after & 
                                           CAR_CODIGO_5PREFER_before != CAR_CODIGO_9PREFER_after & CAR_CODIGO_5PREFER_before != CAR_CODIGO_10PREFER_after, 1, 0)), 
               removed_6 = ifelse(CAR_CODIGO_6PREFER_before == 0, 0, 
                                  ifelse(CAR_CODIGO_6PREFER_before != CAR_CODIGO_1PREFER_after & CAR_CODIGO_6PREFER_before != CAR_CODIGO_2PREFER_after &
                                           CAR_CODIGO_6PREFER_before != CAR_CODIGO_3PREFER_after & CAR_CODIGO_6PREFER_before != CAR_CODIGO_4PREFER_after & 
                                           CAR_CODIGO_6PREFER_before != CAR_CODIGO_5PREFER_after & CAR_CODIGO_6PREFER_before != CAR_CODIGO_6PREFER_after & 
                                           CAR_CODIGO_6PREFER_before != CAR_CODIGO_7PREFER_after & CAR_CODIGO_6PREFER_before != CAR_CODIGO_8PREFER_after & 
                                           CAR_CODIGO_6PREFER_before != CAR_CODIGO_9PREFER_after & CAR_CODIGO_6PREFER_before != CAR_CODIGO_10PREFER_after, 1, 0)), 
               removed_7 = ifelse(CAR_CODIGO_7PREFER_before == 0, 0, 
                                  ifelse(CAR_CODIGO_7PREFER_before != CAR_CODIGO_1PREFER_after & CAR_CODIGO_7PREFER_before != CAR_CODIGO_2PREFER_after &
                                           CAR_CODIGO_7PREFER_before != CAR_CODIGO_3PREFER_after & CAR_CODIGO_7PREFER_before != CAR_CODIGO_4PREFER_after & 
                                           CAR_CODIGO_7PREFER_before != CAR_CODIGO_5PREFER_after & CAR_CODIGO_7PREFER_before != CAR_CODIGO_6PREFER_after & 
                                           CAR_CODIGO_7PREFER_before != CAR_CODIGO_7PREFER_after & CAR_CODIGO_7PREFER_before != CAR_CODIGO_8PREFER_after & 
                                           CAR_CODIGO_7PREFER_before != CAR_CODIGO_9PREFER_after & CAR_CODIGO_7PREFER_before != CAR_CODIGO_10PREFER_after, 1, 0)), 
               removed_8 = ifelse(CAR_CODIGO_8PREFER_before == 0, 0, 
                                  ifelse(CAR_CODIGO_8PREFER_before != CAR_CODIGO_1PREFER_after & CAR_CODIGO_8PREFER_before != CAR_CODIGO_2PREFER_after &
                                           CAR_CODIGO_8PREFER_before != CAR_CODIGO_3PREFER_after & CAR_CODIGO_8PREFER_before != CAR_CODIGO_4PREFER_after & 
                                           CAR_CODIGO_8PREFER_before != CAR_CODIGO_5PREFER_after & CAR_CODIGO_8PREFER_before != CAR_CODIGO_6PREFER_after & 
                                           CAR_CODIGO_8PREFER_before != CAR_CODIGO_7PREFER_after & CAR_CODIGO_8PREFER_before != CAR_CODIGO_8PREFER_after & 
                                           CAR_CODIGO_8PREFER_before != CAR_CODIGO_9PREFER_after & CAR_CODIGO_8PREFER_before != CAR_CODIGO_10PREFER_after, 1, 0)), 
               removed_9 = ifelse(CAR_CODIGO_9PREFER_before == 0, 0, 
                                  ifelse(CAR_CODIGO_9PREFER_before != CAR_CODIGO_1PREFER_after & CAR_CODIGO_9PREFER_before != CAR_CODIGO_2PREFER_after &
                                           CAR_CODIGO_9PREFER_before != CAR_CODIGO_3PREFER_after & CAR_CODIGO_9PREFER_before != CAR_CODIGO_4PREFER_after & 
                                           CAR_CODIGO_9PREFER_before != CAR_CODIGO_5PREFER_after & CAR_CODIGO_9PREFER_before != CAR_CODIGO_6PREFER_after & 
                                           CAR_CODIGO_9PREFER_before != CAR_CODIGO_7PREFER_after & CAR_CODIGO_9PREFER_before != CAR_CODIGO_8PREFER_after & 
                                           CAR_CODIGO_9PREFER_before != CAR_CODIGO_9PREFER_after & CAR_CODIGO_9PREFER_before != CAR_CODIGO_10PREFER_after, 1, 0)), 
               removed_10 = ifelse(CAR_CODIGO_10PREFER_before == 0, 0, 
                                  ifelse(CAR_CODIGO_10PREFER_before != CAR_CODIGO_1PREFER_after & CAR_CODIGO_10PREFER_before != CAR_CODIGO_2PREFER_after &
                                           CAR_CODIGO_10PREFER_before != CAR_CODIGO_3PREFER_after & CAR_CODIGO_10PREFER_before != CAR_CODIGO_4PREFER_after & 
                                           CAR_CODIGO_10PREFER_before != CAR_CODIGO_5PREFER_after & CAR_CODIGO_10PREFER_before != CAR_CODIGO_6PREFER_after & 
                                           CAR_CODIGO_10PREFER_before != CAR_CODIGO_7PREFER_after & CAR_CODIGO_10PREFER_before != CAR_CODIGO_8PREFER_after & 
                                           CAR_CODIGO_10PREFER_before != CAR_CODIGO_9PREFER_after & CAR_CODIGO_10PREFER_before != CAR_CODIGO_10PREFER_after, 1, 0)))
```

```{r}
ta %<>% mutate(added_1 = ifelse(CAR_CODIGO_1PREFER_after == 0, 0, 
                                  ifelse(CAR_CODIGO_1PREFER_after != CAR_CODIGO_1PREFER_before & CAR_CODIGO_1PREFER_after != CAR_CODIGO_2PREFER_before &
                                           CAR_CODIGO_1PREFER_after != CAR_CODIGO_3PREFER_before & CAR_CODIGO_1PREFER_after != CAR_CODIGO_4PREFER_before & 
                                           CAR_CODIGO_1PREFER_after != CAR_CODIGO_5PREFER_before & CAR_CODIGO_1PREFER_after != CAR_CODIGO_6PREFER_before & 
                                           CAR_CODIGO_1PREFER_after != CAR_CODIGO_7PREFER_before & CAR_CODIGO_1PREFER_after != CAR_CODIGO_8PREFER_before & 
                                           CAR_CODIGO_1PREFER_after != CAR_CODIGO_9PREFER_before & CAR_CODIGO_1PREFER_after != CAR_CODIGO_10PREFER_before, 1, 0)), 
               added_2 = ifelse(CAR_CODIGO_2PREFER_after == 0, 0, 
                                  ifelse(CAR_CODIGO_2PREFER_after != CAR_CODIGO_1PREFER_before & CAR_CODIGO_2PREFER_after != CAR_CODIGO_2PREFER_before &
                                           CAR_CODIGO_2PREFER_after != CAR_CODIGO_3PREFER_before & CAR_CODIGO_2PREFER_after != CAR_CODIGO_4PREFER_before & 
                                           CAR_CODIGO_2PREFER_after != CAR_CODIGO_5PREFER_before & CAR_CODIGO_2PREFER_after != CAR_CODIGO_6PREFER_before & 
                                           CAR_CODIGO_2PREFER_after != CAR_CODIGO_7PREFER_before & CAR_CODIGO_2PREFER_after != CAR_CODIGO_8PREFER_before & 
                                           CAR_CODIGO_2PREFER_after != CAR_CODIGO_9PREFER_before & CAR_CODIGO_2PREFER_after != CAR_CODIGO_10PREFER_before, 1, 0)), 
               added_3 = ifelse(CAR_CODIGO_3PREFER_after == 0, 0, 
                                  ifelse(CAR_CODIGO_3PREFER_after != CAR_CODIGO_1PREFER_before & CAR_CODIGO_3PREFER_after != CAR_CODIGO_2PREFER_before &
                                           CAR_CODIGO_3PREFER_after != CAR_CODIGO_3PREFER_before & CAR_CODIGO_3PREFER_after != CAR_CODIGO_4PREFER_before & 
                                           CAR_CODIGO_3PREFER_after != CAR_CODIGO_5PREFER_before & CAR_CODIGO_3PREFER_after != CAR_CODIGO_6PREFER_before & 
                                           CAR_CODIGO_3PREFER_after != CAR_CODIGO_7PREFER_before & CAR_CODIGO_3PREFER_after != CAR_CODIGO_8PREFER_before & 
                                           CAR_CODIGO_3PREFER_after != CAR_CODIGO_9PREFER_before & CAR_CODIGO_3PREFER_after != CAR_CODIGO_10PREFER_before, 1, 0)), 
               added_4 = ifelse(CAR_CODIGO_4PREFER_after == 0, 0, 
                                  ifelse(CAR_CODIGO_4PREFER_after != CAR_CODIGO_1PREFER_before & CAR_CODIGO_4PREFER_after != CAR_CODIGO_2PREFER_before &
                                           CAR_CODIGO_4PREFER_after != CAR_CODIGO_3PREFER_before & CAR_CODIGO_4PREFER_after != CAR_CODIGO_4PREFER_before & 
                                           CAR_CODIGO_4PREFER_after != CAR_CODIGO_5PREFER_before & CAR_CODIGO_4PREFER_after != CAR_CODIGO_6PREFER_before & 
                                           CAR_CODIGO_4PREFER_after != CAR_CODIGO_7PREFER_before & CAR_CODIGO_4PREFER_after != CAR_CODIGO_8PREFER_before & 
                                           CAR_CODIGO_4PREFER_after != CAR_CODIGO_9PREFER_before & CAR_CODIGO_4PREFER_after != CAR_CODIGO_10PREFER_before, 1, 0)), 
               added_5 = ifelse(CAR_CODIGO_5PREFER_after == 0, 0, 
                                  ifelse(CAR_CODIGO_5PREFER_after != CAR_CODIGO_1PREFER_before & CAR_CODIGO_5PREFER_after != CAR_CODIGO_2PREFER_before &
                                           CAR_CODIGO_5PREFER_after != CAR_CODIGO_3PREFER_before & CAR_CODIGO_5PREFER_after != CAR_CODIGO_4PREFER_before & 
                                           CAR_CODIGO_5PREFER_after != CAR_CODIGO_5PREFER_before & CAR_CODIGO_5PREFER_after != CAR_CODIGO_6PREFER_before & 
                                           CAR_CODIGO_5PREFER_after != CAR_CODIGO_7PREFER_before & CAR_CODIGO_5PREFER_after != CAR_CODIGO_8PREFER_before & 
                                           CAR_CODIGO_5PREFER_after != CAR_CODIGO_9PREFER_before & CAR_CODIGO_5PREFER_after != CAR_CODIGO_10PREFER_before, 1, 0)), 
               added_6 = ifelse(CAR_CODIGO_6PREFER_after == 0, 0, 
                                  ifelse(CAR_CODIGO_6PREFER_after != CAR_CODIGO_1PREFER_before & CAR_CODIGO_6PREFER_after != CAR_CODIGO_2PREFER_before &
                                           CAR_CODIGO_6PREFER_after != CAR_CODIGO_3PREFER_before & CAR_CODIGO_6PREFER_after != CAR_CODIGO_4PREFER_before & 
                                           CAR_CODIGO_6PREFER_after != CAR_CODIGO_5PREFER_before & CAR_CODIGO_6PREFER_after != CAR_CODIGO_6PREFER_before & 
                                           CAR_CODIGO_6PREFER_after != CAR_CODIGO_7PREFER_before & CAR_CODIGO_6PREFER_after != CAR_CODIGO_8PREFER_before & 
                                           CAR_CODIGO_6PREFER_after != CAR_CODIGO_9PREFER_before & CAR_CODIGO_6PREFER_after != CAR_CODIGO_10PREFER_before, 1, 0)), 
               added_7 = ifelse(CAR_CODIGO_7PREFER_after == 0, 0, 
                                  ifelse(CAR_CODIGO_7PREFER_after != CAR_CODIGO_1PREFER_before & CAR_CODIGO_7PREFER_after != CAR_CODIGO_2PREFER_before &
                                           CAR_CODIGO_7PREFER_after != CAR_CODIGO_3PREFER_before & CAR_CODIGO_7PREFER_after != CAR_CODIGO_4PREFER_before & 
                                           CAR_CODIGO_7PREFER_after != CAR_CODIGO_5PREFER_before & CAR_CODIGO_7PREFER_after != CAR_CODIGO_6PREFER_before & 
                                           CAR_CODIGO_7PREFER_after != CAR_CODIGO_7PREFER_before & CAR_CODIGO_7PREFER_after != CAR_CODIGO_8PREFER_before & 
                                           CAR_CODIGO_7PREFER_after != CAR_CODIGO_9PREFER_before & CAR_CODIGO_7PREFER_after != CAR_CODIGO_10PREFER_before, 1, 0)), 
               added_8 = ifelse(CAR_CODIGO_8PREFER_after == 0, 0, 
                                  ifelse(CAR_CODIGO_8PREFER_after != CAR_CODIGO_1PREFER_before & CAR_CODIGO_8PREFER_after != CAR_CODIGO_2PREFER_before &
                                           CAR_CODIGO_8PREFER_after != CAR_CODIGO_3PREFER_before & CAR_CODIGO_8PREFER_after != CAR_CODIGO_4PREFER_before & 
                                           CAR_CODIGO_8PREFER_after != CAR_CODIGO_5PREFER_before & CAR_CODIGO_8PREFER_after != CAR_CODIGO_6PREFER_before & 
                                           CAR_CODIGO_8PREFER_after != CAR_CODIGO_7PREFER_before & CAR_CODIGO_8PREFER_after != CAR_CODIGO_8PREFER_before & 
                                           CAR_CODIGO_8PREFER_after != CAR_CODIGO_9PREFER_before & CAR_CODIGO_8PREFER_after != CAR_CODIGO_10PREFER_before, 1, 0)), 
               added_9 = ifelse(CAR_CODIGO_9PREFER_after == 0, 0, 
                                  ifelse(CAR_CODIGO_9PREFER_after != CAR_CODIGO_1PREFER_before & CAR_CODIGO_9PREFER_after != CAR_CODIGO_2PREFER_before &
                                           CAR_CODIGO_9PREFER_after != CAR_CODIGO_3PREFER_before & CAR_CODIGO_9PREFER_after != CAR_CODIGO_4PREFER_before & 
                                           CAR_CODIGO_9PREFER_after != CAR_CODIGO_5PREFER_before & CAR_CODIGO_9PREFER_after != CAR_CODIGO_6PREFER_before & 
                                           CAR_CODIGO_9PREFER_after != CAR_CODIGO_7PREFER_before & CAR_CODIGO_9PREFER_after != CAR_CODIGO_8PREFER_before & 
                                           CAR_CODIGO_9PREFER_after != CAR_CODIGO_9PREFER_before & CAR_CODIGO_9PREFER_after != CAR_CODIGO_10PREFER_before, 1, 0)), 
               added_10 = ifelse(CAR_CODIGO_10PREFER_after == 0, 0, 
                                  ifelse(CAR_CODIGO_10PREFER_after != CAR_CODIGO_1PREFER_before & CAR_CODIGO_10PREFER_after != CAR_CODIGO_2PREFER_before &
                                           CAR_CODIGO_10PREFER_after != CAR_CODIGO_3PREFER_before & CAR_CODIGO_10PREFER_after != CAR_CODIGO_4PREFER_before & 
                                           CAR_CODIGO_10PREFER_after != CAR_CODIGO_5PREFER_before & CAR_CODIGO_10PREFER_after != CAR_CODIGO_6PREFER_before & 
                                           CAR_CODIGO_10PREFER_after != CAR_CODIGO_7PREFER_before & CAR_CODIGO_10PREFER_after != CAR_CODIGO_8PREFER_before & 
                                           CAR_CODIGO_10PREFER_after != CAR_CODIGO_9PREFER_before & CAR_CODIGO_10PREFER_after != CAR_CODIGO_10PREFER_before, 1, 0)))  
```


```{r}
ta %<>% mutate(added = added_1 + added_2 + added_3 + added_4 + added_5 +
                added_6 + added_7 + added_8 + added_9 + added_10)
ta %<>% mutate(removed = removed_1 + removed_2 + removed_3 + removed_4 + removed_5 +
                removed_6 + removed_7 + removed_8 + removed_9 + removed_10)
ta %<>% mutate(removed_with_alert = prob_level_1*removed_1 + prob_level_2*removed_2 + prob_level_3*removed_3 + prob_level_4*removed_4 + prob_level_5*removed_5 +
                prob_level_6*removed_6 + prob_level_7*removed_7 + prob_level_8*removed_8 + prob_level_9*removed_9 + prob_level_10*removed_10)
ta %<>% mutate(removed_without_alert = (1-prob_level_1)*removed_1 + (1-prob_level_2)*removed_2 + (1-prob_level_3)*removed_3 + (1-prob_level_4)*removed_4 + (1-prob_level_5)*removed_5 +
                (1-prob_level_6)*removed_6 + (1-prob_level_7)*removed_7 + (1-prob_level_8)*removed_8 + (1-prob_level_9)*removed_9 + (1-prob_level_10)*removed_10)
```



```{r}
saveRDS(ta, "/Users/iriosu/Dropbox/Mistakes/Code/R/analysis warnings/Data/data_with_apps_treatment_and_probs_v2.rds")
```

# Estadisticas generales
```{r}
ta <- readRDS("/Users/iriosu/Dropbox/Mistakes/Code/R/analysis warnings/Data/data_with_apps_treatment_and_probs_v2.rds")
```

## General
```{r}
# kable(, format="html", digits = 3, caption = "Summary Statistics by Treatment and Period", booktabs = TRUE)
ta %>% group_by(Treatment) %>% summarise(n=n(), views = sum(view), ba = sum(applied_before == 1 & applied_after == 1))
```


## Por universidad
```{r}
out <- data.frame(name=numeric(0), postulo_before= numeric(0), postulaciones_before=numeric(0), postulo_after= numeric(0), postulaciones_after=numeric(0))
for(codu in codus){
  col1 <- paste("postulo_before_", codu, sep="")
  col2 <- paste("postulaciones_before_", codu, sep="")
  col3 <- paste("postulo_after_", codu, sep="")
  col4 <- paste("postulaciones_after_", codu, sep="")
  
  aux <- ta %>% subset(applied_before == 1 & applied_after == 1)
  nm <- as.character(u_names[u_names$CODU == codu, "UNIVERSIDAD"])
  
  out[nrow(out)+1, ] <- c(nm, sum(aux[,col1]), sum(aux[,col2]), sum(aux[,col3]), sum(aux[,col4]))
}
write.csv(out, "/Users/iriosu/Dropbox/Mistakes/Code/R/analysis warnings/Outputs/before_and_after_per_university.csv", row.names = FALSE)
```

## Postulan antes y despues
#### Promedios
```{r}
ta %>% filter(applied_before == 1 & applied_after == 1) %>% group_by(Treatment) %>% summarise(n=n(), nab = mean(n_apps_before), naa = mean(n_apps_after), prob_before = mean(overall_prob_before), prob_after = mean(overall_prob_after))
```
#### Desviaciones estandar
```{r}
ta %>% filter(applied_before == 1 & applied_after == 1) %>% group_by(Treatment) %>% summarise(n=n(), nab = sd(n_apps_before), naa = sd(n_apps_after), prob_before = sd(overall_prob_before), prob_after = sd(overall_prob_after))
```

## Foco en alumnos con alerta roja
#### Promedio
```{r}
ta %>% filter(applied_before == 1 & applied_after == 1) %>% group_by(Treatment, any_low_prob_before) %>% summarise(n = n(), nab = mean(n_apps_before),  naa = mean(n_apps_after), pa = mean(overall_prob_before), pb = mean(overall_prob_after), nalb = mean(num_alerts_before), nala = mean(num_alerts_after))
```

#### Desviacion estandar
```{r}
ta %>% filter(applied_before == 1 & applied_after == 1) %>% group_by(Treatment, any_low_prob_before) %>% summarise(n = n(), nab = sd(n_apps_before),  naa = sd(n_apps_after), pa = sd(overall_prob_before), pb = sd(overall_prob_after), nalb = sd(num_alerts_before), nala = sd(num_alerts_after))
```




## Efecto UBO

```{r}
dat %<>% mutate(napps_ubo_before = (as.numeric(substr(CAR_CODIGO_1PREFER_before, 1, 2)) == 53) + (as.numeric(substr(CAR_CODIGO_2PREFER_before, 1, 2)) == 53) + 
                            (as.numeric(substr(CAR_CODIGO_3PREFER_before, 1, 2)) == 53) + (as.numeric(substr(CAR_CODIGO_4PREFER_before, 1, 2)) == 53) +
                            (as.numeric(substr(CAR_CODIGO_5PREFER_before, 1, 2)) == 53) + (as.numeric(substr(CAR_CODIGO_6PREFER_before, 1, 2)) == 53) +
                            (as.numeric(substr(CAR_CODIGO_7PREFER_before, 1, 2)) == 53) + (as.numeric(substr(CAR_CODIGO_8PREFER_before, 1, 2)) == 53) +
                            (as.numeric(substr(CAR_CODIGO_9PREFER_before, 1, 2)) == 53) + (as.numeric(substr(CAR_CODIGO_10PREFER_before, 1, 2)) == 53), 
            napps_ubo_after = (as.numeric(substr(CAR_CODIGO_1PREFER_after, 1, 2)) == 53) + (as.numeric(substr(CAR_CODIGO_2PREFER_after, 1, 2)) == 53) + 
                            (as.numeric(substr(CAR_CODIGO_3PREFER_after, 1, 2)) == 53) + (as.numeric(substr(CAR_CODIGO_4PREFER_after, 1, 2)) == 53) +
                            (as.numeric(substr(CAR_CODIGO_5PREFER_after, 1, 2)) == 53) + (as.numeric(substr(CAR_CODIGO_6PREFER_after, 1, 2)) == 53) +
                            (as.numeric(substr(CAR_CODIGO_7PREFER_after, 1, 2)) == 53) + (as.numeric(substr(CAR_CODIGO_8PREFER_after, 1, 2)) == 53) +
                            (as.numeric(substr(CAR_CODIGO_9PREFER_after, 1, 2)) == 53) + (as.numeric(substr(CAR_CODIGO_10PREFER_after, 1, 2)) == 53))
```


```{r}
dat %>% group_by(Treatment <= 2) %>% summarise(n=n(), nab = mean(napps_ubo_before), nab.s = sd(napps_ubo_before), naa = mean(napps_ubo_after), naa.s = sd(napps_ubo_after))
```


```{r}
dat %>% group_by(Treatment <= 2 & napps_ubo_before > 0) %>% summarise(n=n(), nab = mean(napps_ubo_before), nab.s = sd(napps_ubo_before), naa = mean(napps_ubo_after), naa.s = sd(napps_ubo_after))
```

```{r}
wilcox.test(ubo$napps_ubo_before, ubo$napps_ubo_after, paired=TRUE) 
```



```{r}
dat %>% filter(Treatment <= 2 & napps_ubo_before > 0) %>% summarise(n_less = sum(napps_ubo_after < napps_ubo_before), n_more = sum(napps_ubo_after  > napps_ubo_before), n_same = sum(napps_ubo_after == napps_ubo_before))
```






## Elimina preferencia por warning

```{r}
colnames(ta)
```

```{r}
ta %>% filter(applied_before == 1 & applied_after == 1) %>% group_by(Treatment, any_low_prob_before) %>% summarise(n = n(), a = mean(added), r = mean(removed), rwa = mean(removed_with_alert), rwoa = mean(removed_without_alert))
```

```{r}
ta %>% filter(applied_before == 1 & applied_after == 1) %>% group_by(Treatment, any_low_prob_before) %>% summarise(n = n(), a = sd(added), r = sd(removed), rwa = sd(removed_with_alert), rwoa = sd(removed_without_alert))
```

# Matching on propensity to open the email
```{r}
ta <- readRDS("/Users/iriosu/Dropbox/Mistakes/Code/R/analysis warnings/Data/data_with_apps_treatment_and_probs_v2.rds")
#ta <- readRDS("~/Dropbox/Mistakes Structural/Data/2021/data_with_apps_treatment_and_probs_v2.rds")
```

```{r}
c_2021 <- read.csv("/Users/iriosu/Dropbox/Mistakes/Code/Python/Cartillas/data/2021/adm2021_archivo_C_demre_2021feb08_MRUN_Compartir.csv", header=TRUE, sep=';')
#c_2021 <- read.csv('~/Dropbox/Mistakes Structural/Data/2021/adm2021_archivo_C_demre_2021feb08_MRUN_Compartir.csv', sep=";", header=TRUE)
```

```{r}
stratas <- read.csv("/Users/iriosu/Dropbox/Mistakes in college admissions/mistakes_and_warnings/data/2021/AppList.csv", header=TRUE, sep=',')
#stratas <- read.csv('~/Dropbox/Mistakes Structural/Data/2021/AppList.csv', sep=',', header=TRUE)
stratas %<>% dplyr::rename(strata=Treatment)
```

```{r}
stratas_detailed <- read.csv("/Users/iriosu/Dropbox/Mistakes in college admissions/mistakes_and_warnings/data/2021/appRCT.csv", header=TRUE, sep=',')
#stratas_detailed <- read.csv('~/Dropbox/Mistakes Structural/Data/2021/appRCT.csv', header=TRUE, sep=',')
```

```{r}
load(file = "~/Dropbox/Mistakes Structural/Data/intermediate_data/appFinal_before_after.rds")
appFinal_before_after %<>% dplyr::rename(mrun=MRUN)
```

```{r}
ta <- merge(dplyr::select(ta, -Treatment), stratas_detailed, by="mrun")
```

```{r}
ta <- merge(ta, c_2021, by="mrun")
ta$promedio_notas <- as.numeric(str_replace(as.character(ta$promedio_notas), ',', '.'))
```

```{r}
ta <- merge(ta, stratas, by="mrun")
```


```{r}
ta <- merge(ta, appFinal_before_after %>% select(mrun,max_app_nro.x, FECHA.x, HORA.x, invalid_programs_before), by="mrun")
```

```{r}
mod_match <- matchit(view ~ factor(rama_educacional) + factor(grupo_dependencia) + factor(codigo_region) + factor(codigo_provincia) + factor(codigo_comuna) + factor(bea) + factor(pace) + promedio_notas + ptje_nem + ptje_ranking + mate_actual + clec_actual + hcso_actual + cien_actual, method='nearest', data=ta %>% filter(!is.na(codigo_comuna)), exact = c("Strata_1", "Strata_2", "Strata_3", "Strata_4"), maxit = 100)

dta_m <- match.data(mod_match)
```

```{r}
dta_m %>% group_by(Strata_1, Strata_2, Strata_3, Strata_4, view) %>% tally()
```


```{r}
#Create variable for whether indiv has valid previous scores:
ta$promedio_lm_anterior <- as.numeric(str_replace(as.character(ta$promedio_lm_anterior), ',', '.'))
ta %<>% mutate(reapplicant = ifelse(promedio_lm_anterior==0,0,1))

#Time-distance between the last application sent and the intervention:
ta %<>% mutate(distance_app_day=ifelse(FECHA.x=="2021-02-13",1, 
                                            ifelse(FECHA.x=="2021-02-12", 2, 
                                                 ifelse(FECHA.x=="2021-02-11", 3, NA))))

ta %<>% mutate(AM=ifelse((strptime(HORA.x, "%H:%M") < strptime("11:49", "%H:%M")), 1,0))

ta %<>% mutate(distance_app_daytime=ifelse(FECHA.x=="2021-02-13" & AM==0, 1, 
                                                ifelse(FECHA.x=="2021-02-13" & AM==1, 2,
                                                       ifelse(FECHA.x=="2021-02-12" & AM==0, 3, 
                                                              ifelse(FECHA.x=="2021-02-12" & AM==1, 4,
                                                                     ifelse(FECHA.x=="2021-02-11" & AM==0, 5,
                                                                            ifelse(FECHA.x=="2021-02-11" & AM==1, 6, NA)))))))
table(ta %>% select(distance_app_daytime), useNA="always")

#Dummy for whether the student submitted at least one invalid application:
ta %<>% mutate(invalid_before = ifelse(invalid_programs_before>0,1,0))

```



```{r}
mod_match2 <- matchit(view ~ factor(rama_educacional) + factor(grupo_dependencia) + factor(codigo_region) + factor(codigo_provincia) + factor(bea) + factor(pace) + promedio_notas + ptje_nem + ptje_ranking + mate_actual + clec_actual + hcso_actual + cien_actual + factor(n_apps_before) + reapplicant + factor(max_app_nro.x) + factor(distance_app_daytime) + invalid_before, method='nearest', data=ta %>% filter(!is.na(codigo_comuna)), exact = c("Strata_1", "Strata_2", "Strata_3", "Strata_4", "strata"), maxit = 100)

dta_m2 <- match.data(mod_match2)
```





```{r}
dta_m %>% group_by(Strata_1, Strata_2, Strata_3, Strata_4, view) %>% tally()
```



```{r}
ta$pace <- as.character(ta$pace)
ta$bea <- as.character(ta$bea)
ta$pace_boo = ifelse(ta$pace == "PACE", 1, 0)
ta$bea_boo = ifelse(ta$bea == "BEA", 1, 0)
```


```{r}
ta %>% group_by(grupo_dependencia) %>% summarise(n=n(), mean(ptje_nem), sd(ptje_nem), mean(mate_actual), sd(mate_actual) )
```


```{r}
summary(feglm(view ~ factor(rama_educacional) + factor(grupo_dependencia) + promedio_notas + bea_boo + pace_boo + ptje_nem + ptje_ranking + mate_actual + clec_actual + hcso_actual + cien_actual | factor(codigo_region) + factor(codigo_provincia) + factor(codigo_comuna) , data=ta %>% filter(!is.na(codigo_comuna))))
```

```{r}
summary(feglm(view ~ factor(rama_educacional) + factor(grupo_dependencia) + promedio_notas + bea_boo + pace_boo + ptje_nem + ptje_ranking + mate_actual + clec_actual + hcso_actual + cien_actual  + factor(n_apps_before) + reapplicant + factor(max_app_nro.x) + factor(distance_app_daytime) + invalid_before | factor(codigo_region) + factor(codigo_provincia), data=ta %>% filter(!is.na(codigo_comuna))))
```



```{r}
saveRDS(dta_m, "/Users/iriosu/Dropbox/Mistakes in college admissions/mistakes_and_warnings/data/2021/matched_sampled_using_propensity_score_view_email.rds")
```


```{r}
saveRDS(dta_m2, "~/Dropbox/Mistakes Structural/Data/2021/matched_sampled_using_propensity_score_view_email_anais.rds")
```


```{r}
all <- read.csv("/Users/iriosu/Dropbox/Mistakes/Code/Python/Cartillas/data/2021/Reporte_diario_postulaciones_last_mrun.csv", header=TRUE, sep=',')
```

```{r}
length(unique(all$MRUN))
```


















# -------------------